<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Traduco</title>
        <style>
            /* Animations */
            @keyframes scene-show {
                from {
                    opacity: 0;
                    transform: translateX(-10%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0%);
                }
            }

            @keyframes details-show {
                from {
                    background-color: var(--colour-border);
                }
                to {
                    background-color: transparent;
                }
            }

            /* All elements */
            :root {
                --colour-bgr-1: #ff9696;
                --colour-bgr-2: #fff5d2;
                --colour-bgr-3: #d7d2ff;
                --colour-text: #000000;
                --colour-button: #ebebff;
                --colour-border: #00557d;
                --colour-input: #ffffd7;
                --colour-tooltip: #ffb4b4;
                --colour-hovered-bgr: #191919;
                --colour-hovered-fgr: #ebebeb;
                --colour-hovered-border: #b4b4b4;
                --colour-disabled-bgr: #afafaf;
                --colour-disabled-fgr: #1e1e1e;
            }

            * {
                color: var(--colour-text);
                border-radius: 4px;
                box-sizing: border-box;
                -moz-box-sizing: border-box;
                -webkit-box-sizing: border-box;
                font-family:
                    system-ui,
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    Roboto,
                    Oxygen,
                    Ubuntu,
                    Cantarell,
                    "Open Sans",
                    "Helvetica Neue",
                    sans-serif;
                transition: background-color 0.4s ease;
                -moz-transition: background-color 0.4s ease;
                -webkit-transition: background-color 0.4s ease;
            }

            /* Elements by tag */
            html {
                align-content: center;
                height: 100%;
            }

            body {
                display: flex;
                flex-direction: column;
                background-color: var(--colour-bgr-2);
                background-image: linear-gradient(
                    60deg,
                    var(--colour-bgr-1),
                    transparent,
                    var(--colour-bgr-3)
                );
                background-attachment: fixed;
                margin: auto;
                font-size: 14pt;
                min-width: 40%;
                max-width: 90%;
                transition: none;
                -moz-transition: none;
                -webkit-transition: none;
            }

            a {
                background-color: transparent;
                color: var(--colour-text);
            }

            button,
            .pseudo-button {
                display: flex;
                flex-grow: 1;
                flex-direction: row;
                align-items: center;
                justify-content: center;
                text-decoration: none;
                background-color: var(--colour-button);
                color: var(--colour-text);
                border: 2px outset var(--colour-border);
                font-size: 1em;
                font-weight: 600;
                margin-block: 2px;
                padding: 2px;
                min-height: 1.7em;
                cursor: default;
            }

            button:disabled,
            .pseudo-button:disabled,
            input:disabled {
                background-color: var(--colour-disabled-bgr);
                color: var(--colour-disabled-fgr);
                cursor: not-allowed;
            }

            caption {
                font-size: 1.1em;
                font-style: italic;
                font-weight: 600;
            }

            details {
                background-color: transparent;
                color: var(--colour-text);
                border: 2px outset var(--colour-border);
                margin-block: 2px;
                padding: 2px 4px;
                max-height: 50vh;
                overflow: auto;
            }

            details[open] {
                animation: details-show 0.6s ease-in;
            }

            details[open] > summary {
                border: 2px outset var(--colour-border);
                background-color: var(--colour-bgr-2);
                background-image: linear-gradient(
                    60deg,
                    var(--colour-bgr-1),
                    transparent,
                    var(--colour-bgr-3)
                );
                color: var(--colour-text);
                opacity: 0.95;
                margin-bottom: 4px;
                padding: 2px;
                position: sticky;
                top: 2px;
                z-index: 9;
            }

            details[open] > summary:focus,
            details[open] > summary:hover,
            details[open]:focus > summary,
            details[open]:hover > summary {
                background-color: var(--colour-button);
                background-image: linear-gradient(
                    60deg,
                    var(--colour-input),
                    transparent,
                    var(--colour-tooltip)
                );
                transition: background-color 0.7s ease;
                -moz-transition: background-color 0.7s ease;
                -webkit-transition: background-color 0.7s ease;
            }

            details[open]:focus-within > summary {
                background-color: var(--colour-button);
                background-image: linear-gradient(
                    60deg,
                    var(--colour-input),
                    transparent,
                    var(--colour-tooltip)
                );
                transition: background-color 0.7s ease;
                -moz-transition: background-color 0.7s ease;
                -webkit-transition: background-color 0.7s ease;
            }

            h1,
            h2,
            h3 {
                text-align: center;
                margin-block: 4px;
            }

            h1 {
                border-bottom: 3px inset var(--colour-border);
                border-radius: 0px;
                font-size: 1.9em;
            }

            h2 {
                font-size: 1.5em;
            }

            h3 {
                font-size: 1.25em;
            }

            hr {
                border-style: none;
                border-top: 4px double var(--colour-border);
                margin-block: 4px;
                width: 100%;
            }

            input,
            textarea {
                background-color: var(--colour-input);
                border: 2px outset var(--colour-border);
                font-size: 1em;
                margin-block: 2px;
                min-height: 1.7em;
            }

            input[type="text"] {
                display: flex;
                flex-direction: row;
                flex-grow: 1;
            }

            p {
                margin-block: 4px;
            }

            select {
                background-color: var(--colour-input);
                color: var(--colour-text);
                border: 2px outset var(--colour-border);
                font-size: 1em;
                margin-block: 2px;
                padding-inline: 4px;
                min-height: 1.7em;
            }

            select:focus > option,
            select:hover > option {
                background-color: var(--colour-hovered-bgr);
                color: var(--colour-hovered-fgr);
            }

            summary {
                border-radius: 4px;
                font-weight: 600;
                cursor: pointer;
            }

            table {
                border-collapse: separate;
                margin-block: 4px;
                width: 100%;
            }

            thead {
                position: sticky;
                top: 0px;
                z-index: 8;
            }

            tfoot {
                position: sticky;
                bottom: 0px;
                z-index: 8;
            }

            tfoot > tr > td,
            tfoot > tr > th {
                background-color: var(--colour-input);
                font-weight: 600;
            }

            td,
            th {
                border: 2px outset var(--colour-border);
                width: 100%;
            }

            td {
                padding-left: 4px;
            }

            th {
                background-color: var(--colour-tooltip);
                font-weight: 600;
                text-align: center;
            }

            tr {
                display: flex;
                flex-direction: row;
                column-gap: 2px;
                margin-block: 2px;
                width: 100%;
            }

            tr:nth-of-type(even) > td {
                background-color: var(--colour-button);
            }

            /* Hovering and focusing */
            button:focus,
            button:hover,
            input:focus,
            input:hover,
            select:focus,
            select:hover,
            summary:focus,
            summary:hover,
            textarea:focus,
            textarea:hover,
            td:focus,
            td:hover,
            th:focus,
            th:hover,
            tr:nth-of-type(even) > td:focus,
            tr:nth-of-type(even) > td:hover,
            .pseudo-button:focus,
            .pseudo-button:hover {
                background-color: var(--colour-hovered-bgr);
                color: var(--colour-hovered-fgr);
                border-color: var(--colour-hovered-border);
                transition: background-color 0.4s ease;
                -moz-transition: background-color 0.4s ease;
                -webkit-transition: background-color 0.4s ease;
            }

            /* Classes */
            .button-container {
                display: flex;
                flex-wrap: wrap;
                flex-direction: row;
                column-gap: 4px;
            }

            .scene {
                display: none;
                flex-direction: column;
                animation: scene-show 0.4s ease;
            }

            .setting-div {
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                column-gap: 4px;
                align-items: center;
            }

            .settings-list {
                display: flex;
                flex-direction: column;
                margin-block: 4px;
                row-gap: 2px;
            }

            .table-text {
                display: flex;
                flex-direction: row;
                background-color: transparent;
                resize: vertical;
                min-height: 100%;
                max-height: 50vh;
                height: 100%;
                width: 100%;
                margin: 0px;
            }

            .tooltip-parent {
                position: relative;
            }

            .tooltip-parent:focus > .tooltip,
            .tooltip-parent:hover > .tooltip {
                display: flex;
            }

            .tooltip {
                display: none;
                flex-direction: row;
                background-color: var(--colour-tooltip);
                color: var(--colour-text);
                border: 2px outset var(--colour-border);
                padding: 0px 6px 0px 0px;
                max-height: 60%;
                max-width: 50%;
                cursor: help;
                font-style: italic;
                font-weight: 400;
                text-align: left;
                opacity: 0.95;
                position: fixed;
                top: 8px;
                left: 8px;
                z-index: 10;
                overflow: auto;
            }

            .tooltip::before {
                content: "i";
                background-color: var(--colour-text);
                color: var(--colour-tooltip);
                border-radius: 0px;
                margin-right: 4px;
                height: fit-content;
                padding-inline: 0.5em;
                font-style: italic;
                font-weight: 600;
            }

            /* Elements by ID */
            #lang {
                margin-bottom: 10px;
            }

            #menu {
                display: flex;
            }

            #author {
                background-color: var(--colour-tooltip);
                color: var(--colour-text);
                border: 2px outset var(--colour-border);
                text-align: center;
                font-size: 1em;
                margin-block: 2px;
                margin-top: 10px;
                padding: 2px;
                cursor: help;
                width: 100%;
                opacity: 0.9;
            }

            #author:focus,
            #author:hover {
                background-color: var(--colour-hovered-bgr);
                color: var(--colour-hovered-fgr);
                border-color: var(--colour-hovered-border);
            }

            #author:focus > a,
            #author:hover > a {
                color: var(--colour-hovered-fgr);
            }

            #notes {
                resize: none;
                height: 100%;
                width: 100%;
                margin: 0px;
                padding-left: 8px;
                font-weight: 600;
                overflow: hidden;
            }

            #notes-container {
                display: flex;
                flex-direction: row;
                align-items: center;
                background-color: transparent;
                border: none;
                padding: 0px;
                opacity: 0.8;
                height: 1.8em;
                transition: height 0.4s ease;
            }

            #notes-container:focus,
            #notes-container:hover {
                opacity: 0.95;
                height: 30vh;
            }

            #notes-container:focus > #notes,
            #notes-container:hover > #notes {
                overflow: auto;
            }

            #notes-container::after,
            #notes-container::before {
                content: "?";
                align-content: center;
                background-color: var(--colour-text);
                color: var(--colour-bgr-2);
                border-radius: 4px;
                font-family: "Courier New", Courier, monospace;
                font-size: 1.2em;
                font-weight: 600;
                text-align: center;
                margin-inline: 2px;
                height: 100%;
                width: 1.6em;
                cursor: help;
            }

            #table-source-stats,
            #table-target-stats {
                border-left: none;
                padding: 0px 4px 0px 0px;
                border-top: 2px outset var(--colour-border);
                border-bottom: 2px outset var(--colour-border);
                border-right: 2px outset var(--colour-border);
                overflow: auto;
            }

            #table-source-stats:before,
            #table-target-stats:before {
                content: "Aa:";
                background-color: var(--colour-text);
                color: var(--colour-bgr-2);
                border-radius: 2px 0px 0px 2px;
                padding-inline: 4px;
                margin-right: 4px;
            }

            /* Media queries */
            @media (min-width: 720px) {
                body {
                    max-width: 70%;
                }
            }
        </style>
    </head>
    <body>
        <button id="exportLang" onclick="exportTranslationTemplate()">
            Export texts for translation
        </button>

        <!-- Menu div -->
        <div id="menu" class="scene" tabindex="1">
            <h1 id="title" tabindex="1">Traduco</h1>

            <select id="lang" tabindex="0"></select>

            <input type="file" id="load-project" accept=".txt,.json" style="display: none" />

            <button id="start-button" tabindex="1" class="tooltip-parent">
                Open
                <span class="tooltip">Open a text (.txt) or a project (.json)</span>
            </button>
            <button id="continue-button" tabindex="1" disabled>Continue</button>
            <button id="save-button" tabindex="1" onclick="switchScene('menu', 'saving')" disabled>
                Save
            </button>
            <button id="settings-button" tabindex="1" onclick="switchScene('menu', 'settings')">
                Settings
            </button>
            <button id="about-button" tabindex="1" onclick="switchScene('menu', 'about')">
                About
            </button>

            <!-- Author -->
            <p id="author" tabindex="0" class="tooltip-parent">
                Made by
                <a href="https://github.com/VitalRus95" target="_blank"
                    >Vitaly Pavlovich Ulyanov (Vital)</a
                >.
                <span class="tooltip">Learn more on my GitHub page!</span>
            </p>
        </div>

        <!-- Main div -->
        <div id="main" class="scene" tabindex="0">
            <button id="main-back" onclick="switchScene('main', 'menu')">Back</button>

            <h3 id="project-name" tabindex="0" contenteditable="true">...</h3>

            <table>
                <thead>
                    <tr>
                        <th id="table-source" tabindex="0">Source</th>
                        <th id="table-target" tabindex="0">Target</th>
                    </tr>

                    <tr>
                        <th id="notes-container" colspan="2">
                            <textarea id="notes" autocomplete="off" placeholder="Notes"></textarea>
                        </th>
                    </tr>
                </thead>

                <tbody id="table-body"></tbody>

                <tfoot>
                    <tr>
                        <td id="table-source-stats" tabindex="0"></td>
                        <td id="table-target-stats" tabindex="0"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Saving div -->
        <div id="saving" class="scene" tabindex="0">
            <button id="saving-back" onclick="switchScene('saving', 'menu')">Back</button>

            <h2 id="saving-title" tabindex="0">Save</h2>

            <a id="save-project" href="" download="Project.json" class="pseudo-button">Project</a>
            <a id="save-source" href="" download="Source.txt" class="pseudo-button">Source</a>
            <a id="save-target" href="" download="Target.txt" class="pseudo-button">Target</a>
            <a id="save-notes" href="" download="Notes.txt" class="pseudo-button">Notes</a>
        </div>

        <!-- Settings div -->
        <div id="settings" class="scene" tabindex="0">
            <h2 id="settings-title" tabindex="0">Settings</h2>

            <button id="settings-back" onclick="switchScene('settings', 'menu')">Back</button>

            <!-- Sound settings -->
            <details>
                <summary id="sound-settings">Sound</summary>

                <ul class="settings-list">
                    <!-- Volume -->
                    <li>
                        <label for="set-volume" id="volume-label">Sound volume</label>
                        <input
                            type="number"
                            id="set-volume"
                            min="0"
                            max="1"
                            step="0.1"
                            value="0.5"
                        />
                    </li>

                    <!-- Default sounds (buttons, inputs, etc.) -->
                    <li>
                        <div class="setting-div">
                            <label for="set-def-sounds" id="def-sounds-label"
                                >Default sounds (buttons, inputs, etc.)</label
                            >
                            <input type="checkbox" id="set-def-sounds" checked />
                        </div>
                    </li>
                </ul>
            </details>

            <!-- Colour scheme settings -->
            <details>
                <summary id="colour-settings">Colours</summary>

                <div class="button-container">
                    <input type="file" id="colour-loader" accept=".json" style="display: none" />
                    <button id="load-colours">Load colours</button>
                    <a id="save-colours" href="" download="Colours.json" class="pseudo-button"
                        >Save colours</a
                    >
                </div>

                <ul id="colours" class="settings-list"></ul>

                <div class="button-container">
                    <button id="example-button">Button example</button>
                    <button id="example-disabled-button" disabled>Disabled button example</button>
                    <input
                        type="text"
                        id="example-input"
                        placeholder="Input example"
                        value="12345 ABCDE"
                    />
                </div>
            </details>

            <!-- Translation settings -->
            <details>
                <summary id="translation-settings">Translation</summary>

                <ul class="settings-list">
                    <li>
                        <label for="set-newlines" id="newlines-label"
                            >Number of new lines between paragraphs in saved texts</label
                        >
                        <input
                            type="number"
                            id="set-newlines"
                            min="1"
                            max="10"
                            step="1"
                            value="2"
                        />
                    </li>
                </ul>
            </details>

            <button id="default-settings">Restore default settings</button>
        </div>

        <!-- About div -->
        <div id="about" class="scene" tabindex="0">
            <h2 id="about-title" tabindex="0">About</h2>

            <button id="about-back" onclick="switchScene('about', 'menu')">Back</button>

            <p id="about-p" tabindex="0">
                A simple translation tool allowing to precisely track your progress and symbol
                count.
            </p>
        </div>

        <script>
            // Elements
            /** @type {HTMLDivElement} */
            let menu = document.getElementById("menu");
            /** @type {HTMLDivElement} */
            let main = document.getElementById("main");
            /** @type {HTMLDivElement} */
            let saving = document.getElementById("saving");
            /** @type {HTMLHeadingElement} */
            let projectName = document.getElementById("project-name");
            /** @type {HTMLTextAreaElement} */
            let notes = document.getElementById("notes");
            /** @type {HTMLTableCellElement} */
            let tableSource = document.getElementById("table-source");
            /** @type {HTMLTableCellElement} */
            let tableTarget = document.getElementById("table-target");
            /** @type {HTMLTableSectionElement} */
            let tableBody = document.getElementById("table-body");
            /** @type {HTMLTableSectionElement} */
            let tableSourceStats = document.getElementById("table-source-stats");
            /** @type {HTMLTableSectionElement} */
            let tableTargetStats = document.getElementById("table-target-stats");
            /** @type {HTMLDivElement} */
            let settings = document.getElementById("settings");
            /** @type {HTMLUListElement} */
            let colours = document.getElementById("colours");
            /** @type {HTMLDivElement} */
            let about = document.getElementById("about");
            /** @type {HTMLInputElement} */
            let colourLoader = document.getElementById("colour-loader");
            /** @type {HTMLButtonElement} */
            let loadColours = document.getElementById("load-colours");
            /** @type {HTMLAnchorElement} */
            let saveColours = document.getElementById("save-colours");
            /** @type {HTMLButtonElement} */
            let startButton = document.getElementById("start-button");
            /** @type {HTMLButtonElement} */
            let continueButton = document.getElementById("continue-button");
            /** @type {HTMLInputElement} */
            let loadProjectInput = document.getElementById("load-project");
            /** @type {HTMLButtonElement} */
            let saveButton = document.getElementById("save-button");
            /** @type {HTMLAnchorElement} */
            let saveProject = document.getElementById("save-project");
            /** @type {HTMLAnchorElement} */
            let saveSource = document.getElementById("save-source");
            /** @type {HTMLAnchorElement} */
            let saveTarget = document.getElementById("save-target");
            /** @type {HTMLAnchorElement} */
            let saveNotes = document.getElementById("save-notes");

            /** @type {HTMLInputElement} */
            let volumeInput = document.getElementById("set-volume");
            /** @type {HTMLInputElement} */
            let defaultSounds = document.getElementById("set-def-sounds");
            /** @type {HTMLButtonElement} */
            let defaultSettings = document.getElementById("default-settings");
            /** @type {HTMLInputElement} */
            let newLines = document.getElementById("set-newlines");

            continueButton.disabled = true;
            saveButton.disabled = true;

            // Types
            /** @typedef Paragraph
             * @property {string} source;
             * @property {string} target;
             */

            // Objects
            const allColours = {
                "--colour-bgr-1": "#ff9696",
                "--colour-bgr-2": "#fff5d2",
                "--colour-bgr-3": "#d7d2ff",
                "--colour-text": "#000000",
                "--colour-button": "#ebebff",
                "--colour-border": "#00557d",
                "--colour-input": "#ffffd7",
                "--colour-tooltip": "#ffb4b4",
                "--colour-hovered-bgr": "#191919",
                "--colour-hovered-fgr": "#ebebeb",
                "--colour-hovered-border": "#b4b4b4",
                "--colour-disabled-bgr": "#afafaf",
                "--colour-disabled-fgr": "#1e1e1e",
            };

            // Variables
            /** @type {AudioContext} */
            let audio = new (window.AudioContext || window.webkitAudioContext)();

            /** @type {{
                name: string;
                notes: string;
                lastId: string;
                selection: [number, number];
                paragraphs: Paragraph[];
            }} */
            let project = {};
            /** @type {number} */
            let totalSourceLength = 0;
            /** @type {number} */
            let totalTargetLength = 0;

            // Settings' events
            volumeInput.addEventListener("change", function (event) {
                volumeInput.value = clamp(0, +volumeInput.value, 1);
                localStorage.setItem("volume", volumeInput.value);
            });

            defaultSounds.addEventListener("change", function (event) {
                localStorage.setItem("default-sounds", this.checked);
            });

            defaultSettings.addEventListener("click", function (event) {
                // Volume
                volumeInput.value = "0.5";
                localStorage.setItem("volume", volumeInput.value);

                // Default sounds
                defaultSounds.checked = true;
                localStorage.setItem("default-sounds", this.checked);

                // Colours
                for (const c in allColours) {
                    document.body.style.setProperty(c, allColours[c]);
                    document.getElementById(c).value = allColours[c];
                    localStorage.setItem(c, allColours[c]);
                }
            });

            // Colour settings
            Object.keys(allColours).forEach((c) => {
                document.body.style.setProperty(
                    c,
                    localStorage.getItem(c) ?? getComputedStyle(document.body).getPropertyValue(c),
                );

                /** @type {HTMLLIElement} */
                let item = colours.appendChild(document.createElement("li"));
                /** @type {HTMLLabelElement} */
                let label = item.appendChild(document.createElement("label"));
                /** @type {HTMLInputElement} */
                let input = item.appendChild(document.createElement("input"));

                label.id = `${c}-label`;
                label.htmlFor = c;
                label.textContent = c;
                label.style.marginRight = "4px";

                input.id = c;
                input.type = "color";
                input.value = document.body.style.getPropertyValue(c);
                input.addEventListener("input", function () {
                    document.body.style.setProperty(c, this.value);
                    localStorage.setItem(c, this.value);
                });

                if (c === "--colour-tooltip") {
                    item.classList.add("tooltip-parent");
                    /** @type {HTMLSpanElement} */
                    let tooltip = item.appendChild(document.createElement("span"));

                    tooltip.id = "example-tooltip";
                    tooltip.classList.add("tooltip");
                    tooltip.textContent = "Tooltip example";
                }
            });

            // Loading colours
            loadColours.addEventListener("click", function (event) {
                colourLoader.click();
            });

            colourLoader.addEventListener("change", async function (event) {
                await colourLoader.files[0].text().then((content) => {
                    try {
                        let loadedColours = JSON.parse(content);

                        for (const c in loadedColours) {
                            document.body.style.setProperty(c, loadedColours[c]);
                            document.getElementById(c).value = loadedColours[c];
                            localStorage.setItem(c, loadedColours[c]);
                            this.value = "";
                        }
                    } catch (error) {
                        alert(`Error while reading colours file: ${error}`);
                    }
                });
            });

            // Saving colours
            saveColours.addEventListener("click", function (event) {
                let savedColours = {};

                Object.keys(allColours).forEach((c) => {
                    savedColours[c] = document.body.style.getPropertyValue(c);
                });

                let data = encodeURIComponent(JSON.stringify(savedColours, undefined, 4));
                this.href = `data:text/plain;charset=utf-8,${data}`;
            });

            // Translation settings
            newLines.addEventListener("change", function (event) {
                localStorage.setItem(
                    "new-lines",
                    clamp(+newLines.min, +newLines.value, +newLines.max),
                );
            });

            // Exiting on pressing Escape
            main.addEventListener("keydown", function (event) {
                if (event.key === "Escape") switchScene("main", "menu");
            });
            saving.addEventListener("keydown", function (event) {
                if (event.key === "Escape") switchScene("saving", "menu");
            });
            settings.addEventListener("keydown", function (event) {
                if (event.key === "Escape") switchScene("settings", "menu");
            });
            about.addEventListener("keydown", function (event) {
                if (event.key === "Escape") switchScene("about", "menu");
            });

            // Default sounds
            document
                .querySelectorAll("button, input, select, textarea, summary, a")
                .forEach((e) => {
                    e.addEventListener("click", function (event) {
                        if (!defaultSounds.checked) return;
                        playSound("sine", [250, 50, 100], 0.1);
                    });
                });

            // Project name
            projectName.addEventListener("input", function (event) {
                project.name = projectName.textContent;
            });

            // Project notes
            notes.addEventListener("input", function (event) {
                project.notes = notes.value;
            });

            // Loading project
            startButton.addEventListener("click", function (event) {
                loadProjectInput.click();
            });

            continueButton.addEventListener("click", function (event) {
                switchScene("menu", "main");
                /** @type {HTMLTextAreaElement} */
                let lastText = document.getElementById(project.lastId);
                if (lastText) {
                    lastText.setSelectionRange(...project.selection);
                    lastText.focus();
                }
            });

            loadProjectInput.addEventListener("change", async function (event) {
                await loadProjectInput.files[0].text().then((content) => {
                    try {
                        let name = loadProjectInput.files[0].name;

                        if (name.endsWith(".json")) {
                            // A project is loaded
                            project = JSON.parse(content);
                        } else {
                            // A source text is loaded
                            project.name = loadProjectInput.files[0].name.replace(".txt", "");
                            project.lastId = `t0`;
                            project.notes = "";
                            project.selection = [0, 0];
                            project.paragraphs = [];
                            content.split("\n").forEach((p) => {
                                if (p.trim() === "") return;
                                project.paragraphs.push({
                                    source: p.trimEnd(),
                                    target: "",
                                });
                            });
                        }
                        fillTable();
                        continueButton.disabled = false;
                        saveButton.disabled = false;
                        projectName.textContent = project.name;
                        notes.value = project.notes;
                    } catch (error) {
                        alert(`Error while opening the file: ${error}`);
                    }
                });
            });

            // Saving project, source, target, and notes
            saveProject.addEventListener("click", function (event) {
                let data = encodeURIComponent(JSON.stringify(project, undefined, 4));
                this.download = `${project.name}.json`;
                this.href = `data:text/plain;charset=utf-8,${data}`;
            });

            saveSource.addEventListener("click", function (event) {
                let numNewLines = clamp(+newLines.min, +newLines.value, +newLines.max);
                let data = "";
                project.paragraphs.forEach((p, i) => {
                    if (p.source === "") return;
                    if (i > 0) {
                        data += `${"\n".repeat(numNewLines)}${p.source}`;
                    } else {
                        data += `${p.source}`;
                    }
                });
                this.download = `${project.name} [${tableSource.textContent}].txt`;
                this.href = `data:text/plain;charset=utf-8,${data}`;
            });

            saveTarget.addEventListener("click", function (event) {
                let numNewLines = clamp(+newLines.min, +newLines.value, +newLines.max);
                let data = "";
                project.paragraphs.forEach((p, i) => {
                    if (p.target === "") return;
                    if (i > 0) {
                        data += `${"\n".repeat(numNewLines)}${p.target}`;
                    } else {
                        data += `${p.target}`;
                    }
                });
                this.download = `${project.name} [${tableTarget.textContent}].txt`;
                this.href = `data:text/plain;charset=utf-8,${data}`;
            });

            saveNotes.addEventListener("click", function (event) {
                let data = encodeURIComponent(project.notes);
                this.download = `${project.name} [${notes.placeholder}].txt`;
                this.href = `data:text/plain;charset=utf-8,${data}`;
            });

            // Functions
            function fillTable() {
                switchScene("menu", "main");
                while (tableBody.hasChildNodes()) tableBody.lastChild.remove();

                /** @type {number} */
                let index = 0;

                project.paragraphs.forEach((p, i) => {
                    /** @type {HTMLTableRowElement} */
                    let row = tableBody.appendChild(document.createElement("tr"));

                    /** @type {HTMLTableDataCellElement} */
                    let dataSource = row.appendChild(document.createElement("td"));
                    dataSource.style.border = "none";
                    dataSource.style.padding = "0px";

                    /** @type {HTMLTextAreaElement} */
                    let textSource = dataSource.appendChild(document.createElement("textarea"));
                    textSource.id = `s${index}`;
                    textSource.value = p.source;
                    textSource.dataset.type = "source";
                    textSource.classList.add("table-text");
                    textSource.style.height = textSource.scrollHeight * 2 + "px";

                    /** @type {HTMLTableDataCellElement} */
                    let dataTarget = row.appendChild(document.createElement("td"));
                    dataTarget.style.border = "none";
                    dataTarget.style.padding = "0px";

                    /** @type {HTMLTextAreaElement */
                    let textTarget = dataTarget.appendChild(document.createElement("textarea"));
                    textTarget.id = `t${index}`;
                    textTarget.value = p.target;
                    textTarget.dataset.type = "target";
                    textTarget.classList.add("table-text");

                    // Common source & target text areas' events
                    [textSource, textTarget].forEach((t) => {
                        // Input actions
                        t.addEventListener("input", function (event) {
                            if (t === textSource) {
                                project.paragraphs[i].source = this.value;
                            } else {
                                project.paragraphs[i].target = this.value;
                            }
                            updateTotalLengths();
                            updateStatistics(this);
                        });

                        // Other actions
                        ["click", "focus", "select"].forEach((e) => {
                            t.addEventListener(e, function (event) {
                                updateStatistics(this);

                                // Update last selected table cell
                                project.lastId = this.id;
                                project.selection = [this.selectionStart, this.selectionEnd];
                            });
                        });
                    });

                    index++;
                });

                updateStatistics();

                /** @type {HTMLTextAreaElement} */
                let lastText = document.getElementById(project.lastId);
                if (lastText) {
                    lastText.setSelectionRange(...project.selection);
                    lastText.focus();
                }
            }

            function updateTotalLengths() {
                totalSourceLength = 0;
                totalTargetLength = 0;

                project.paragraphs.forEach((p) => {
                    totalSourceLength += p.source.length;
                    totalTargetLength += p.target.length;
                });
            }

            function getTargetToSourceRatio() {
                let percent = (totalTargetLength / totalSourceLength) * 100;
                return percent > 0 && percent < 1000 ? percent : undefined;
            }

            /**
             * @param {HTMLTextAreaElement} text
             */
            function updateStatistics(text = undefined) {
                // If no text area is given, only show total lengths
                if (!text) {
                    updateTotalLengths();
                    tableSourceStats.textContent = totalSourceLength;
                    tableTargetStats.textContent = totalTargetLength;

                    let percent = getTargetToSourceRatio();
                    if (percent) {
                        tableTargetStats.textContent += ` (${percent.toFixed(0)}%)`;
                    }
                    return;
                }

                // If a text area is given, proceed normally
                /** @type {string} */
                let result = "";
                /** @type {number} */
                let textLength = text.value.length;
                /** @type {number} */
                let selection = text.selectionEnd - text.selectionStart;
                /** @type {number} */
                let totalLength =
                    text.dataset.type === "source" ? totalSourceLength : totalTargetLength;
                /** @type {HTMLTableDataCellElement} */
                let cell = text.dataset.type === "source" ? tableSourceStats : tableTargetStats;

                if (selection > 0) result += `${selection}/`;
                result += `${textLength}/`;
                result += `${totalLength}`;

                if (text.dataset.type === "target") {
                    let percent = getTargetToSourceRatio();
                    if (percent) {
                        result += ` (${percent.toFixed(0)}%)`;
                    }
                }

                cell.textContent = result;
            }

            function loadSettings() {
                // Volume
                volumeInput.value = localStorage.getItem("volume") ?? "0.5";

                // Default sounds
                if (localStorage.getItem("default-sounds")) {
                    defaultSounds.checked = localStorage.getItem("default-sounds") === "true";
                } else {
                    defaultSounds.checked = true;
                    localStorage.setItem("default-sounds", "true");
                }

                // Translation settings
                newLines.value = localStorage.getItem("new-lines") ?? "2";
            }

            function switchScene(from, to) {
                if (from === to) return;

                try {
                    document.getElementById(from).style.display = "none";
                    document.getElementById(to).style.display = "flex";
                    document.getElementById(to).focus();
                } catch (error) {
                    console.log(error);
                }
            }

            /**
             * @param {'square' | 'sawtooth' | 'triangle' | 'sine'} type
             * @param {number[]} frequencies
             * @param {number} duration
             */
            function playSound(type, frequencies, duration) {
                if (!audio || +volumeInput.value === 0) return;

                /** @type {OscillatorNode} */
                let oscillator = audio.createOscillator();
                /** @type {GainNode} */
                let volume = audio.createGain();

                oscillator.type = type;
                oscillator.frequency.value = frequencies[0];
                oscillator.frequency.setValueCurveAtTime(frequencies, audio.currentTime, duration);
                oscillator.connect(volume);

                volume.gain.value = +volumeInput.value;
                volume.gain.setValueCurveAtTime(
                    [0, +volumeInput.value, 0],
                    audio.currentTime,
                    duration,
                );
                volume.connect(audio.destination);

                oscillator.start();
                oscillator.stop(audio.currentTime + duration);
            }

            /**
             * @param {number} min
             * @param {number} value
             * @param {number} max
             * @returns {number}
             */
            function ringClamp(min, value, max) {
                return value < min ? max : value > max ? min : value;
            }

            /**
             * @param {number} min
             * @param {number} value
             * @param {number} max
             * @returns {number}
             */
            function clamp(min, value, max) {
                return value < min ? min : value > max ? max : value;
            }

            /**
             * @typedef {Object} Translation
             * @property {string} name
             * @property {string[]} langTags
             * @property {LangElement[]} elements
             */
            /**
             * @param {Translation[]} languages
             */
            function generateLanguagesList(languages) {
                /** @type {HTMLSelectElement} */
                let list = document.getElementById("lang");
                list.addEventListener("change", function (event) {
                    selectLanguage(languages, true);
                });

                for (let l of languages) {
                    /** @type {HTMLOptionElement} */
                    let option = list.appendChild(document.createElement("option"));
                    option.value = l.name;
                    option.textContent = l.name;
                }

                selectLanguage(languages, false);
            }

            /**
             * @param {Translation[]} languages
             * @param {boolean} fromMenu
             */
            function selectLanguage(languages, fromMenu) {
                /** @type {HTMLSelectElement} */
                let menu = document.getElementById("lang");
                /** @type {string} */
                let selection = null;

                if (!fromMenu) {
                    if (localStorage.getItem("lang")) {
                        selection = localStorage.getItem("lang");
                        menu.value = selection;
                    } else if (navigator.language) {
                        // Iterate over translations
                        for (let l of languages) {
                            // If the valid option is finally found, exit
                            if (selection) {
                                break;
                            } else if (l.langTags) {
                                // Otherwise iterate over the tags and
                                // compare them to the browser language
                                for (let t of l.langTags) {
                                    if (navigator.language === t) {
                                        menu.value = l.name;
                                        selection = l.name;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } else {
                    selection = menu.value;
                }

                if (selection) {
                    /** @type {Translation} */
                    let translation = {};

                    for (let l of languages) {
                        if (l.name === selection) {
                            translation = l;
                            break;
                        }
                    }

                    if (translation) {
                        localStorage.setItem("lang", selection);

                        for (let e of translation.elements) {
                            let target = document.getElementById(e.id);

                            if (target) {
                                if (e.textContent) {
                                    target.textContent = e.textContent;
                                }

                                if (e.placeholder) {
                                    target.placeholder = e.placeholder;
                                }

                                if (e.childNodesTexts) {
                                    /** @type {number} */
                                    let index = 0;

                                    for (let c of target.childNodes) {
                                        if (
                                            c.textContent &&
                                            c.textContent.trim() !== "" &&
                                            e.childNodesTexts[index]
                                        ) {
                                            c.textContent = e.childNodesTexts[index];
                                            index++;
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }

            /**
             * @typedef {Object} LangElement
             * @property {string} id
             * @property {string} textContent
             * @property {string} placeholder
             * @property {string[]} childNodesTexts
             */
            function exportTranslationTemplate() {
                /** @type {LangElement[]} */
                let elements = [];

                document.querySelectorAll("body *").forEach((e) => {
                    if (
                        e.tagName !== "DIV" &&
                        e.tagName !== "DETAILS" &&
                        e.tagName !== "TABLE" &&
                        e.id &&
                        e.id !== "lang"
                    ) {
                        /** @type {LangElement} */
                        let newEl = {};

                        newEl.id = e.id;

                        if (e.childNodes) {
                            newEl.childNodesTexts = [];

                            for (let n of e.childNodes) {
                                if (n.textContent && n.textContent.trim() !== "") {
                                    newEl.childNodesTexts.push(n.textContent.trim());
                                }
                            }
                        } else {
                            if (e.textContent) {
                                newEl.textContent = e.textContent;
                            }
                        }

                        if (e.placeholder) {
                            newEl.placeholder = e.placeholder;
                        }

                        if (
                            newEl.textContent ||
                            newEl.placeholder ||
                            newEl?.childNodesTexts.length > 0
                        ) {
                            elements.push(newEl);
                        }
                    }
                });

                navigator.clipboard.writeText(JSON.stringify(elements, null, 4));
                alert("Translation template copied to clipboard!");
            }

            // Resetting some elements & loading settings
            loadSettings();
            generateLanguagesList([
                {
                    name: "English [Vitaly Ulyanov]",
                    langTags: [
                        "en",
                        "en-AU",
                        "en-BZ",
                        "en-CA",
                        "en-CB",
                        "en-GB",
                        "en-IE",
                        "en-JM",
                        "en-NZ",
                        "en-PH",
                        "en-TT",
                        "en-US",
                        "en-ZA",
                        "en-ZW",
                    ],
                    elements: [
                        {
                            id: "exportLang",
                            childNodesTexts: ["Export texts for translation"],
                        },
                        {
                            id: "title",
                            childNodesTexts: ["Traduco"],
                        },
                        {
                            id: "start-button",
                            childNodesTexts: ["Open", "Open a text (.txt) or a project (.json)"],
                        },
                        {
                            id: "continue-button",
                            childNodesTexts: ["Continue"],
                        },
                        {
                            id: "save-button",
                            childNodesTexts: ["Save"],
                        },
                        {
                            id: "settings-button",
                            childNodesTexts: ["Settings"],
                        },
                        {
                            id: "about-button",
                            childNodesTexts: ["About"],
                        },
                        {
                            id: "author",
                            childNodesTexts: [
                                "Made by ",
                                "Vitaly Pavlovich Ulyanov (Vital)",
                                ".",
                                "Learn more on my GitHub page!",
                            ],
                        },
                        {
                            id: "main-back",
                            childNodesTexts: ["Back"],
                        },
                        {
                            id: "table-source",
                            childNodesTexts: ["Source"],
                        },
                        {
                            id: "table-target",
                            childNodesTexts: ["Target"],
                        },
                        {
                            id: "notes",
                            childNodesTexts: [],
                            placeholder: "Notes",
                        },
                        {
                            id: "saving-back",
                            childNodesTexts: ["Back"],
                        },
                        {
                            id: "saving-title",
                            childNodesTexts: ["Save"],
                        },
                        {
                            id: "save-project",
                            childNodesTexts: ["Project"],
                        },
                        {
                            id: "save-source",
                            childNodesTexts: ["Source"],
                        },
                        {
                            id: "save-target",
                            childNodesTexts: ["Target"],
                        },
                        {
                            id: "save-notes",
                            childNodesTexts: ["Notes"],
                        },
                        {
                            id: "settings-title",
                            childNodesTexts: ["Settings"],
                        },
                        {
                            id: "settings-back",
                            childNodesTexts: ["Back"],
                        },
                        {
                            id: "sound-settings",
                            childNodesTexts: ["Sound"],
                        },
                        {
                            id: "volume-label",
                            childNodesTexts: ["Sound volume"],
                        },
                        {
                            id: "def-sounds-label",
                            childNodesTexts: ["Default sounds (buttons, inputs, etc.)"],
                        },
                        {
                            id: "colour-settings",
                            childNodesTexts: ["Colours"],
                        },
                        {
                            id: "load-colours",
                            childNodesTexts: ["Load colours"],
                        },
                        {
                            id: "save-colours",
                            childNodesTexts: ["Save colours"],
                        },
                        {
                            id: "--colour-bgr-1-label",
                            childNodesTexts: ["Background (left)"],
                        },
                        {
                            id: "--colour-bgr-2-label",
                            childNodesTexts: ["Background (centre)"],
                        },
                        {
                            id: "--colour-bgr-3-label",
                            childNodesTexts: ["Background (right)"],
                        },
                        {
                            id: "--colour-text-label",
                            childNodesTexts: ["Text"],
                        },
                        {
                            id: "--colour-button-label",
                            childNodesTexts: ["Buttons"],
                        },
                        {
                            id: "--colour-border-label",
                            childNodesTexts: ["Borders"],
                        },
                        {
                            id: "--colour-input-label",
                            childNodesTexts: ["Inputs"],
                        },
                        {
                            id: "--colour-tooltip-label",
                            childNodesTexts: ["Tooltip's background"],
                        },
                        {
                            id: "example-tooltip",
                            childNodesTexts: ["Tooltip example"],
                        },
                        {
                            id: "--colour-hovered-bgr-label",
                            childNodesTexts: ["Hovered element's background"],
                        },
                        {
                            id: "--colour-hovered-fgr-label",
                            childNodesTexts: ["Hovered element's text"],
                        },
                        {
                            id: "--colour-hovered-border-label",
                            childNodesTexts: ["Hovered element's border"],
                        },
                        {
                            id: "--colour-disabled-bgr-label",
                            childNodesTexts: ["Disabled element's background"],
                        },
                        {
                            id: "--colour-disabled-fgr-label",
                            childNodesTexts: ["Disabled element's text"],
                        },
                        {
                            id: "example-button",
                            childNodesTexts: ["Button example"],
                        },
                        {
                            id: "example-disabled-button",
                            childNodesTexts: ["Disabled button example"],
                        },
                        {
                            id: "example-input",
                            childNodesTexts: [],
                            placeholder: "Input example",
                        },
                        {
                            id: "translation-settings",
                            childNodesTexts: ["Translation"],
                        },
                        {
                            id: "newlines-label",
                            childNodesTexts: [
                                "Number of new lines between paragraphs in saved texts",
                            ],
                        },
                        {
                            id: "default-settings",
                            childNodesTexts: ["Restore default settings"],
                        },
                        {
                            id: "about-title",
                            childNodesTexts: ["About"],
                        },
                        {
                            id: "about-back",
                            childNodesTexts: ["Back"],
                        },
                        {
                            id: "about-p",
                            childNodesTexts: [
                                "A simple translation tool allowing to precisely track your progress and symbol count.",
                            ],
                        },
                    ],
                },
                {
                    name: " [ ]",
                    langTags: ["ru", "ru-RU"],
                    elements: [
                        {
                            id: "exportLang",
                            childNodesTexts: ["   "],
                        },
                        {
                            id: "title",
                            childNodesTexts: ["Traduco"],
                        },
                        {
                            id: "start-button",
                            childNodesTexts: ["", "  (.txt)   (.json)"],
                        },
                        {
                            id: "continue-button",
                            childNodesTexts: [""],
                        },
                        {
                            id: "save-button",
                            childNodesTexts: [""],
                        },
                        {
                            id: "settings-button",
                            childNodesTexts: [""],
                        },
                        {
                            id: "about-button",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "author",
                            childNodesTexts: [
                                "  ",
                                "   (Vital)",
                                ".",
                                "   GitHub!",
                            ],
                        },
                        {
                            id: "main-back",
                            childNodesTexts: [""],
                        },
                        {
                            id: "table-source",
                            childNodesTexts: [""],
                        },
                        {
                            id: "table-target",
                            childNodesTexts: [""],
                        },
                        {
                            id: "notes",
                            childNodesTexts: [],
                            placeholder: "",
                        },
                        {
                            id: "saving-back",
                            childNodesTexts: [""],
                        },
                        {
                            id: "saving-title",
                            childNodesTexts: [""],
                        },
                        {
                            id: "save-project",
                            childNodesTexts: [""],
                        },
                        {
                            id: "save-source",
                            childNodesTexts: [""],
                        },
                        {
                            id: "save-target",
                            childNodesTexts: [""],
                        },
                        {
                            id: "save-notes",
                            childNodesTexts: [""],
                        },
                        {
                            id: "settings-title",
                            childNodesTexts: [""],
                        },
                        {
                            id: "settings-back",
                            childNodesTexts: [""],
                        },
                        {
                            id: "sound-settings",
                            childNodesTexts: [""],
                        },
                        {
                            id: "volume-label",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "def-sounds-label",
                            childNodesTexts: ["  (,    ..)"],
                        },
                        {
                            id: "colour-settings",
                            childNodesTexts: [""],
                        },
                        {
                            id: "load-colours",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "save-colours",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "--colour-bgr-1-label",
                            childNodesTexts: [" ( )"],
                        },
                        {
                            id: "--colour-bgr-2-label",
                            childNodesTexts: [" ( )"],
                        },
                        {
                            id: "--colour-bgr-3-label",
                            childNodesTexts: [" ( )"],
                        },
                        {
                            id: "--colour-text-label",
                            childNodesTexts: [""],
                        },
                        {
                            id: "--colour-button-label",
                            childNodesTexts: [""],
                        },
                        {
                            id: "--colour-border-label",
                            childNodesTexts: [""],
                        },
                        {
                            id: "--colour-input-label",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "--colour-tooltip-label",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "example-tooltip",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "--colour-hovered-bgr-label",
                            childNodesTexts: ["   "],
                        },
                        {
                            id: "--colour-hovered-fgr-label",
                            childNodesTexts: ["   "],
                        },
                        {
                            id: "--colour-hovered-border-label",
                            childNodesTexts: ["   "],
                        },
                        {
                            id: "--colour-disabled-bgr-label",
                            childNodesTexts: ["  "],
                        },
                        {
                            id: "--colour-disabled-fgr-label",
                            childNodesTexts: ["  "],
                        },
                        {
                            id: "example-button",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "example-disabled-button",
                            childNodesTexts: ["  "],
                        },
                        {
                            id: "example-input",
                            childNodesTexts: [],
                            placeholder: "  ",
                        },
                        {
                            id: "translation-settings",
                            childNodesTexts: [""],
                        },
                        {
                            id: "newlines-label",
                            childNodesTexts: [
                                "       ",
                            ],
                        },
                        {
                            id: "default-settings",
                            childNodesTexts: ["  "],
                        },
                        {
                            id: "about-title",
                            childNodesTexts: [" "],
                        },
                        {
                            id: "about-back",
                            childNodesTexts: [""],
                        },
                        {
                            id: "about-p",
                            childNodesTexts: [
                                "          .",
                            ],
                        },
                    ],
                },
            ]);
        </script>
    </body>
</html>
