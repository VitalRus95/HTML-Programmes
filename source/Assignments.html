<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <meta http-equiv='X-UA-Compatible' content='IE=edge' />
        <title>Assignments</title>
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='stylesheet' href='../resources/VitalStyle.css' />

        <style>
            .equal-width-div {
                display: flex;
                flex-wrap: wrap;
                column-gap: 4px;
            }

            .equal-width-div > button, div {
                width: 100%;
            }

            .menu-button {
                background-color: transparent;
                flex-grow: 1;
                border-radius: 0px;
                font-weight: 600;
                margin: 0;
                padding: 2px;
                min-width: fit-content;
                max-width: 100%;
            }

            .table-head {
                top: 32px;
            }

            .table-data {
                text-align: left;
                height: 100%;
                width: 100%;
            }

            .table-input {
                border-style: none;
                margin: 0px;
                height: 100%;
                width: 100%;
            }

            .text {
                display: flex;
                resize: vertical;
                min-height: 10vh;
                max-height: 50vh;
                height: 30vh;
                width: 100%;
            }

            #editor {
                font-family: 'Courier New', Courier, monospace;
                font-weight: 600;
            }

            #selects-div {
                display: flex;
                column-gap: 4px;
            }

            #group-select, #subject-select {
                width: 100%;
            }

            #ra-div {
                display: flex;
                flex-wrap: wrap;
                column-gap: 4px;
                margin: 0px;
                position: sticky;
                bottom: 0px;
                opacity: 0.95;
            }

            #ra-num {
                flex-grow: 1;
                background-color: var(--primary-colour);
            }

            #table-reset, #random-assignments {
                flex-grow: 1;
            }
        </style>
    </head>
    <body>
        <h1 id='page-title'>Assignments</h1>

        <!-- Settings -->
        <details id='settings'>
            <summary id='settings-summary'>Settings</summary>
        </details>

        <!-- Page main body -->

        <!-- Save/Load buttons -->
        <div style='display: flex; column-gap: 4px;'>
            <!-- Load button -->
            <button
                id='loadInfoButton'
                class='menuButton tooltipParent'
                onclick='document.getElementById("loadInfoInput").click()'
                style='border-radius: 7px 0px 0px 0px;'
            >
                &#128193; Load
                <span class='tooltip'>Load assignments from .json file</span>
            </button>
            <input
                id='loadInfoInput'
                type='file'
                accept='.json'
                onchange='loadInfo()'
                style='display: none;'
            >
            </input>

            <!-- Save button -->
            <a
                id='saveInfoButton'
                href=''
                class='menuButton tooltipParent'
                onclick='saveInfo()'
                style='border-radius: 0px 7px 0px 0px;'
            >
                &#128190; Save
                <span class='tooltip'>Save assignments to .json file</span>
            </a>
        </div>

        <!-- Editor -->
        <details>
            <summary id='editor-summary'>Edit assignments file</summary>

            <textarea id='editor' class='text' wrap='off'></textarea>

            <div class='equal-width-div'>
                <button id='editor-reset'>Discard changes</button>
                <button id='editor-apply'>Apply changes</button>
            </div>
        </details>

        <hr>

        <h2 id='selects-heading'>View assignments</h2>

        <!-- Group selection -->
        <div id='group-selection'>
            <!-- Menus -->
            <div id='selects-div'>
                <!-- Group menu -->
                <select id='group-select'>
                    <option value='' id='group-hint'>Group</option>
                </select>

                <!-- Subject menu -->
                <select id='subject-select'>
                    <option value='' id='subject-hint'>Subject</option>
                </select>
            </div>

            <!-- Completed assignments -->
            <details open>
                <summary id='completed-summary'>Completed assignments</summary>
                <table>
                    <thead>
                        <tr>
                            <th id='th-assignment1' class='table-head' tabindex='0'>
                                Assignment
                            </th>
                            <th id='th-date1' class='table-head' tabindex='0'>
                                Date
                            </th>
                        </tr>
                    </thead>

                    <tbody id='completed-table'></tbody>
                </table>
            </details>

            <!-- Available assignments -->
            <details open>
                <summary id='available-summary'>Available assignments</summary>
                <table>
                    <!-- Table heading -->
                    <thead>
                        <tr>
                            <th id='th-assignment2' class='table-head' tabindex='0'>
                                Assignment
                            </th>
                            <th id='th-date2' class='table-head' tabindex='0'>
                                Date
                            </th>
                        </tr>
                    </thead>

                    <!-- Generated table -->
                    <tbody id='available-table'></tbody>
                </table>

            <!-- Table buttons: reset & randomise -->
                <div id='ra-div'>
                    <button id='table-reset'>Reset</button>
                    
                    <button id='random-assignments'>
                        Randomise
                    </button>

                    <input
                        type='number'
                        id='ra-num'
                        min='1'
                        max='300'
                        value='1'
                        autocomplete='off'
                    >
                </div>
            </details>
        </div>

        <p id='author' class='box' style='font-style: italic'>
            Made by Vitaly Pavlovich Ulyanov.
        </p>
        <!-- –ê–≤—Ç–æ—Ä ‚Äî –í–∏—Ç–∞–ª–∏–π –ü–∞–≤–ª–æ–≤–∏—á –£–ª—å—è–Ω–æ–≤. -->

        <script src='../resources/VitalLogic.js'></script>
        <script>
            // Elements
            /** @type {HTMLAnchorElement} */
            let saveInfoButton = document.getElementById('saveInfoButton');
            /** @type {HTMLInputElement} */
            let loadInfoInput = document.getElementById('loadInfoInput');
            /** @type {HTMLTextAreaElement} */
            let editor = document.getElementById('editor');
            /** @type {HTMLButtonElement} */
            let editorReset = document.getElementById('editor-reset');
            /** @type {HTMLButtonElement} */
            let editorApply = document.getElementById('editor-apply');
            /** @type {HTMLSelectElement} */
            let groupSelect = document.getElementById('group-select');
            /** @type {HTMLSelectElement} */
            let subjectSelect = document.getElementById('subject-select');
            /** @type {HTMLTableSectionElement} */
            let completedTable = document.getElementById('completed-table');
            /** @type {HTMLTableSectionElement} */
            let availableTable = document.getElementById('available-table');
            /** @type {HTMLButtonElement} */
            let randomAssignments = document.getElementById('random-assignments');
            /** @type {HTMLInputElement} */
            let randomAssignmentsCount = document.getElementById('ra-num');
            /** @type {HTMLButtonElement} */
            let tableReset = document.getElementById('table-reset');

            // Variables
            let info = {
                /** @type {string[]} */
                groups: [],
                subjects: {}
            };

            // Process editor
            editor.addEventListener('input', function (/** @type {InputEvent} */ event) {
                if (!event.data) return;
                const cursor = this.selectionEnd;

                // Replace ' with "
                this.value = this.value.replace(/'/g, '"');
                this.selectionEnd = cursor;

                // Autocomplete
                switch (event.data) {
                    case '{':
                        insertText(this, '},');
                        break;
                    case '(':
                        insertText(this, ')');
                        break;
                    case '[':
                        insertText(this, ']');
                        break;
                    case '\'':
                    case '"':
                        insertText(this, '"');
                        break;
                    case ' ':
                        if (this.value[cursor - 2] !== '\n'
                            && this.value[cursor - 2] !== ' '
                        ) {
                            break;
                        };
                        insertText(this, '   ', 3);
                        break;
                    default:
                        break;
                }
            });

            // Process editor's buttons
            editorReset.addEventListener('click', function () {
                fillEditor();
            });

            editorApply.addEventListener('click', function () {
                try {
                    let newInfo = JSON.parse(editor.value);

                    if (!newInfo.groups) newInfo.groups = [];
                    if (!newInfo.subjects) newInfo.subject = {};

                    info = newInfo;
                    fillEditor();
                    updateGroupSelect();
                    updateSubjectSelect();
                    updateAssignmentsTable();
                } catch (error) {
                    alert(`Error while applying changes: ${error}`);
                }
            });

            // Process menus
            groupSelect.addEventListener('change', updateAssignmentsTable);
            subjectSelect.addEventListener('change', updateAssignmentsTable);

            // Process table buttons
            randomAssignments.addEventListener('click', function () {
                updateAssignmentsTable();

                const max = clamp(
                    +randomAssignmentsCount.min,
                    +randomAssignmentsCount.value,
                    +randomAssignmentsCount.max
                );
                randomAssignmentsCount.value = max;

                while (availableTable.children.length > max) {
                    availableTable.children[
                        getRandomInt(0, availableTable.children.length)
                    ].remove();
                }
            });

            tableReset.addEventListener('click', function () {
                updateAssignmentsTable();
            });

            /**
             * @param {number} min
             * @param {number} value
             * @param {number} maxnumber
            */
            function clamp(min, value, max) {
                return value > max
                    ? max
                    : value < min
                        ? min
                        : value;
            }

            /**
             * @param {HTMLInputElement | HTMLTextAreaElement} textElement
             * @param {string} insertedText
             * @param {number} [shiftCursor=0]
            */
            function insertText(textElement, insertedText, shiftCursor = 0) {
                const cursor = textElement.selectionEnd;

                textElement.value = textElement.value.substring(0, cursor)
                    + insertedText
                    + textElement.value.substring(cursor);
                
                textElement.selectionEnd = cursor + shiftCursor;
            }

            async function loadInfo() {
                await loadInfoInput.files[0].text().then(content => {
                    try {
                        info = JSON.parse(content);

                        // Update menus & table
                        fillEditor();
                        updateGroupSelect();
                        updateSubjectSelect();
                        updateAssignmentsTable();
                    } catch (error) {
                        alert(`Error while reading assignments file: ${error}`);
                    }
                });
            }

            function saveInfo() {
                let data = encodeURIComponent(
                    JSON.stringify(info, undefined, 4)
                );
                saveInfoButton.download = 'Assignments.json';
                saveInfoButton.href = `data:text/plain;charset=utf-8,${data}`;
            }

            /**
             * @param {number} min
             * @param {number} max
             * @returns Random number in [min;max) range
            */
            function getRandomInt(min, max) {
                return Math.floor(
                    Math.random() * (max - min)
                ) + min;
            }

            function generateInfoTemplate() {
                const group = document.getElementById('group-hint').textContent.trim();
                const subject = document.getElementById('subject-hint').textContent.trim();
                const assignment = document.getElementById('th-assignment1').textContent.trim();

                // Fill template with randomised info
                ['1', '2', '3'].forEach(i => {
                    const g = `${group} ${i}`;
                    const s = `${subject} ${i}`;

                    info.groups.push(g);
                    info.subjects[s] = {};

                    ['1', '2', '3'].forEach(j => {
                        const a = `${assignment} ${j}`;

                        info.subjects[s][a] = {};
                        if (j === '3') return;

                        for (let k = 1; k < getRandomInt(2, 5); k++) {
                            info.subjects[s][a][`${group} ${k}`] = `${
                                getRandomInt(2000, 2026)
                            }-${
                                getRandomInt(1, 13).toString().padStart(2, '0')
                            }-${
                                getRandomInt(1, 29).toString().padStart(2, '0')
                            }`;
                        }
                    });
                });

                // Set placeholder
                editor.placeholder = JSON.stringify(info, undefined, 4);
            }

            function fillEditor() {
                editor.value = JSON.stringify(info, undefined, 4);
            }

            function updateGroupSelect() {
                while (groupSelect.hasChildNodes()) groupSelect.lastChild.remove();

                info.groups.forEach(g => {
                    let option = groupSelect.appendChild(
                        document.createElement('option')
                    );
                    option.value = g;
                    option.textContent = g;
                });
            }

            function updateSubjectSelect() {
                while (subjectSelect.hasChildNodes()) subjectSelect.lastChild.remove();

                for (const s in info.subjects) {
                    const element = info.subjects[s];
                    
                    let option = subjectSelect.appendChild(
                        document.createElement('option')
                    );
                    option.value = s;
                    option.textContent = s;
                }
            }

            function updateAssignmentsTable() {
                while (completedTable.hasChildNodes()) completedTable.lastChild.remove();
                while (availableTable.hasChildNodes()) availableTable.lastChild.remove();
                if (!groupSelect.value) return;
                if (!subjectSelect.value) return;

                const g = groupSelect.value;
                const s = subjectSelect.value;

                let completedCount = 0;
                let availableCount = 0;

                for (const a in info.subjects[s]) {
                    const assignment = info.subjects[s][a];
                    const table = (assignment[g]) ? completedTable : availableTable;
                    const count = (assignment[g]) ? ++completedCount : ++availableCount;
                    
                    let row = table.appendChild(
                        document.createElement('tr')
                    );

                    let nameColumn = row.appendChild(
                        document.createElement('td')
                    );
                    nameColumn.classList = 'table-data';
                    nameColumn.textContent = count + '. ' + a;
                    nameColumn.tabIndex = 0;

                    let dateColumn = row.appendChild(
                        document.createElement('td')
                    );
                    dateColumn.classList = 'table-data';
                    
                    let dateInput = dateColumn.appendChild(
                        document.createElement('input')
                    );
                    dateInput.type = 'date';
                    dateInput.classList = 'table-input';
                    dateInput.value = assignment[g] ?? '';
                    dateInput.tabIndex = 0;
                    dateInput.addEventListener('change', function () {
                        if (this.value) {
                            assignment[g] = this.value;
                        } else {
                            delete assignment[g];
                        }
                        updateAssignmentsTable();
                    });
                }

                randomAssignmentsCount.max = availableTable.children.length - 1;
            }
            
            generateLanguagesList([
                {
                    name: 'English [Vitaly Ulyanov]',
                    langTags: ['en', 'en-AU', 'en-BZ', 'en-CA', 'en-CB', 'en-GB', 'en-IE', 'en-JM', 'en-NZ', 'en-PH', 'en-TT', 'en-US', 'en-ZA', 'en-ZW'],
                    elements: [
                        {
                            "id": "page-title",
                            "childNodesTexts": [
                                "Assignments"
                            ]
                        },
                        {
                            "id": "settings-summary",
                            "childNodesTexts": [
                                "Settings"
                            ]
                        },
                        {
                            "id": "fontLabel",
                            "childNodesTexts": [
                                "Font"
                            ]
                        },
                        {
                            "id": "fontInput",
                            "childNodesTexts": [],
                            "placeholder": "Type a font's name and press Enter"
                        },
                        {
                            "id": "primLabel",
                            "childNodesTexts": [
                                "Background colour"
                            ]
                        },
                        {
                            "id": "secLabel",
                            "childNodesTexts": [
                                "Text colour"
                            ]
                        },
                        {
                            "id": "acc1Label",
                            "childNodesTexts": [
                                "Accent colour 1"
                            ]
                        },
                        {
                            "id": "acc2Label",
                            "childNodesTexts": [
                                "Accent colour 2"
                            ]
                        },
                        {
                            "id": "loadLabel",
                            "childNodesTexts": [
                                "üìÅ Load colours"
                            ]
                        },
                        {
                            "id": "saveColoursButton",
                            "childNodesTexts": [
                                "üíæ Save colours"
                            ]
                        },
                        {
                            "id": "exportLang",
                            "childNodesTexts": [
                                "üåê Export texts for translation"
                            ]
                        },
                        {
                            "id": "loadInfoButton",
                            "childNodesTexts": [
                                "üìÅ Load",
                                "Load assignments from .json file"
                            ]
                        },
                        {
                            "id": "saveInfoButton",
                            "childNodesTexts": [
                                "üíæ Save",
                                "Save assignments to .json file"
                            ]
                        },
                        {
                            "id": "editor-summary",
                            "childNodesTexts": [
                                "Edit assignments file"
                            ]
                        },
                        {
                            "id": "editor-reset",
                            "childNodesTexts": [
                                "Discard changes"
                            ]
                        },
                        {
                            "id": "editor-apply",
                            "childNodesTexts": [
                                "Apply changes"
                            ]
                        },
                        {
                            "id": "selects-heading",
                            "childNodesTexts": [
                                "View assignments"
                            ]
                        },
                        {
                            "id": "group-select",
                            "childNodesTexts": [
                                "Group"
                            ]
                        },
                        {
                            "id": "group-hint",
                            "childNodesTexts": [
                                "Group"
                            ]
                        },
                        {
                            "id": "subject-select",
                            "childNodesTexts": [
                                "Subject"
                            ]
                        },
                        {
                            "id": "subject-hint",
                            "childNodesTexts": [
                                "Subject"
                            ]
                        },
                        {
                            "id": "completed-summary",
                            "childNodesTexts": [
                                "Completed assignments"
                            ]
                        },
                        {
                            "id": "th-assignment1",
                            "childNodesTexts": [
                                "Assignment"
                            ]
                        },
                        {
                            "id": "th-date1",
                            "childNodesTexts": [
                                "Date"
                            ]
                        },
                        {
                            "id": "available-summary",
                            "childNodesTexts": [
                                "Available assignments"
                            ]
                        },
                        {
                            "id": "table-reset",
                            "childNodesTexts": [
                                "Reset"
                            ]
                        },
                        {
                            "id": "random-assignments",
                            "childNodesTexts": [
                                "Randomise"
                            ]
                        },
                        {
                            "id": "th-assignment2",
                            "childNodesTexts": [
                                "Assignment"
                            ]
                        },
                        {
                            "id": "th-date2",
                            "childNodesTexts": [
                                "Date"
                            ]
                        },
                        {
                            "id": "author",
                            "childNodesTexts": [
                                "Made by Vitaly Pavlovich Ulyanov."
                            ]
                        },
                        {
                            "id": "fullscreenButton",
                            "childNodesTexts": [
                                "‚ñ≤",
                                "Fullscreen"
                            ]
                        }
                    ]
                },
                {
                    name: '–†—É—Å—Å–∫–∏–π [–í–∏—Ç–∞–ª–∏–π –£–ª—å—è–Ω–æ–≤]',
                    langTags: ['ru', 'ru-RU'],
                    elements: [
                        {
                            "id": "page-title",
                            "childNodesTexts": [
                                "–ó–∞–¥–∞–Ω–∏—è"
                            ]
                        },
                        {
                            "id": "settings-summary",
                            "childNodesTexts": [
                                "–ù–∞—Å—Ç—Ä–æ–π–∫–∏"
                            ]
                        },
                        {
                            "id": "fontLabel",
                            "childNodesTexts": [
                                "–®—Ä–∏—Ñ—Ç"
                            ]
                        },
                        {
                            "id": "fontInput",
                            "childNodesTexts": [],
                            "placeholder": "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ Enter"
                        },
                        {
                            "id": "primLabel",
                            "childNodesTexts": [
                                "–¶–≤–µ—Ç —Ñ–æ–Ω–∞"
                            ]
                        },
                        {
                            "id": "secLabel",
                            "childNodesTexts": [
                                "–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞"
                            ]
                        },
                        {
                            "id": "acc1Label",
                            "childNodesTexts": [
                                "–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç 1"
                            ]
                        },
                        {
                            "id": "acc2Label",
                            "childNodesTexts": [
                                "–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç 2"
                            ]
                        },
                        {
                            "id": "loadLabel",
                            "childNodesTexts": [
                                "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ü–≤–µ—Ç–∞"
                            ]
                        },
                        {
                            "id": "saveColoursButton",
                            "childNodesTexts": [
                                "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞"
                            ]
                        },
                        {
                            "id": "exportLang",
                            "childNodesTexts": [
                                "üåê –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞"
                            ]
                        },
                        {
                            "id": "loadInfoButton",
                            "childNodesTexts": [
                                "üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å",
                                "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .json"
                            ]
                        },
                        {
                            "id": "saveInfoButton",
                            "childNodesTexts": [
                                "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å",
                                "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏—è –≤ —Ñ–∞–π–ª .json"
                            ]
                        },
                        {
                            "id": "editor-summary",
                            "childNodesTexts": [
                                "–ü—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª –∑–∞–¥–∞–Ω–∏–π"
                            ]
                        },
                        {
                            "id": "editor-reset",
                            "childNodesTexts": [
                                "–û—Ç–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∫–∏"
                            ]
                        },
                        {
                            "id": "editor-apply",
                            "childNodesTexts": [
                                "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∫–∏"
                            ]
                        },
                        {
                            "id": "selects-heading",
                            "childNodesTexts": [
                                "–ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–¥–∞–Ω–∏—è"
                            ]
                        },
                        {
                            "id": "group-select",
                            "childNodesTexts": [
                                "–ì—Ä—É–ø–ø–∞"
                            ]
                        },
                        {
                            "id": "group-hint",
                            "childNodesTexts": [
                                "–ì—Ä—É–ø–ø–∞"
                            ]
                        },
                        {
                            "id": "subject-select",
                            "childNodesTexts": [
                                "–ü—Ä–µ–¥–º–µ—Ç"
                            ]
                        },
                        {
                            "id": "subject-hint",
                            "childNodesTexts": [
                                "–ü—Ä–µ–¥–º–µ—Ç"
                            ]
                        },
                        {
                            "id": "completed-summary",
                            "childNodesTexts": [
                                "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è"
                            ]
                        },
                        {
                            "id": "th-assignment1",
                            "childNodesTexts": [
                                "–ó–∞–¥–∞–Ω–∏–µ"
                            ]
                        },
                        {
                            "id": "th-date1",
                            "childNodesTexts": [
                                "–î–∞—Ç–∞"
                            ]
                        },
                        {
                            "id": "available-summary",
                            "childNodesTexts": [
                                "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è"
                            ]
                        },
                        {
                            "id": "table-reset",
                            "childNodesTexts": [
                                "–°–±—Ä–æ—Å"
                            ]
                        },
                        {
                            "id": "random-assignments",
                            "childNodesTexts": [
                                "–ü–µ—Ä–µ–º–µ—à–∞—Ç—å"
                            ]
                        },
                        {
                            "id": "th-assignment2",
                            "childNodesTexts": [
                                "–ó–∞–¥–∞–Ω–∏–µ"
                            ]
                        },
                        {
                            "id": "th-date2",
                            "childNodesTexts": [
                                "–î–∞—Ç–∞"
                            ]
                        },
                        {
                            "id": "author",
                            "childNodesTexts": [
                                "–ê–≤—Ç–æ—Ä ‚Äî –í–∏—Ç–∞–ª–∏–π –ü–∞–≤–ª–æ–≤–∏—á –£–ª—å—è–Ω–æ–≤."
                            ]
                        },
                        {
                            "id": "fullscreenButton",
                            "childNodesTexts": [
                                "‚ñ≤",
                                "–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω"
                            ]
                        }
                    ]
                }
            ]);

            generateInfoTemplate();
            fillEditor();
        </script>
    </body>
</html>
