<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <meta http-equiv='X-UA-Compatible' content='IE=edge' />
        <title>Sums</title>
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='stylesheet' href='../resources/VitalStyle.css' />

        <style>
            :root {
                --cell-size: calc(32px + 2.3vw);
                --cell-border: calc(var(--cell-size) * 0.05);
                --font-size: calc(var(--cell-size) * 0.65);
                --sum-font-size: calc(var(--font-size) * 0.9);
                --row-sum-size: calc(var(--cell-size) * 0.8);
                --row-sum-font-size: calc(var(--font-size) * 0.75);
            }

            @media (max-width: 390px) {
                :root {
                    --cell-size: calc(26px + 3vw);
                }
            }

            #container {
                display: flex;
                flex-direction: row;
                justify-content: center;
            }

            #grid {
                display: flex;
                flex-direction: column;
                row-gap: 2px;
                overflow-x: auto;
                overflow-y: hidden;
            }

            @keyframes win-blink {
                25% {
                    box-shadow: inset 0px 0px 15px var(--accent1);
                }
                50% {
                    box-shadow: none;
                }
                75% {
                    box-shadow: inset 0px 0px 15px var(--secondary-colour);
                }
            }

            #grid-victory {
                align-self: center;
                text-align: center;
                font-size: 1.5em;
                font-weight: 600;
                background-image: linear-gradient(315deg, var(--accent1), transparent 15% 85%, var(--accent1));
                border: 2px solid var(--accent1);
                border-radius: 7px 7px 0px 0px;
                padding: 2px;
                width: 100%;
                animation: win-blink 12s ease alternate infinite;
            }

            #grid-win {
                display: none;
                flex-direction: column;
            }

            #rules {
                text-indent: 16px;
            }

            #rules-sums {
                display: flex;
                flex-direction: column;
                row-gap: 4px;
            }

            #rules-sums > li > span,
            #rules-keyboard-list > li > span {
                display: flex;
                flex-direction: row;
                align-items: baseline;
                column-gap: 8px;
            }

            #rules-sums > li > span > .sum,
            #rules-sums > li > span > .row-sum,
            #rules-sums > li > span > .column-sum,
            #rules-sums > li > span > .diagonal-sum {
                align-self: baseline;
            }

            #rules-sums > li > span > .sum {
                height: calc(var(--cell-size) * 0.7);
                width: calc(var(--cell-size) * 0.7);
                font-size: calc(var(--sum-font-size) * 0.7);
            }

            #rules-sums > li > span > .row-sum {
                height: calc(var(--cell-size) * 0.9);
                width: calc(var(--row-sum-size) * 0.9);
                font-size: calc(var(--row-sum-font-size) * 0.9);
            }

            #rules-sums > li > span > .column-sum {
                height: calc(var(--row-sum-size) * 0.9);
                width: calc(var(--cell-size) * 0.9);
                font-size: calc(var(--row-sum-font-size) * 0.9);
            }

            #rules-sums > li > span > .diagonal-sum {
                height: calc(var(--row-sum-size) * 0.9);
                width: calc(var(--row-sum-size) * 0.9);
                font-size: calc(var(--row-sum-font-size) * 0.9);
            }

            .row {
                display: flex;
                column-gap: 2px;
                width: fit-content;
                margin: 0;
            }

            .corner {
                height: var(--row-sum-size);
                width: var(--row-sum-size);
            }

            .cell-container {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: transparent;
                border-radius: 4px;
                font-family: 'Courier New', Courier, monospace;
                font-size: var(--font-size);
                font-weight: 900;
                text-align: center;
                padding: 2px;
                margin: 0;
                outline-style: none;
                width: var(--cell-size);
                height: var(--cell-size);
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
            }

            .cell {
                background-color: var(--accent2);
                color: var(--secondary-colour);
                border: var(--cell-border) ridge var(--accent1);
                cursor: pointer;
                transition: all 1s ease;
            }

            .cell::selection,
            .sum::selection,
            .cell:invalid {
                background-color: transparent;
            }

            .cell:focus,
            .cell:hover,
            .cell:invalid:focus,
            .cell:invalid:hover,
            .highlight,
            .highlight:invalid {
                background-color: var(--secondary-colour);
                color: var(--primary-colour);
                transition: none;
            }

            .cell:read-only:focus {
                background-color: var(--accent1);
            }

            .cell:-moz-read-only:focus {
                background-color: var(--accent1);
            }

            .sum {
                background-color: transparent;
                color: var(--secondary-colour);
                border-color: var(--secondary-colour);
                border-style: solid;
                border-radius: 50%;
                font-size: var(--sum-font-size);
                cursor: cell;
                transition: all 0.3s ease;
            }

            .sum:focus,
            .sum:hover {
                background-color: var(--primary-colour);
                color: var(--secondary-colour);
                border-color: var(--accent1);
                border-radius: 4px;
                transform: scale(1.4);
            }

            .diagonal-sum,
            .column-sum,
            .row-sum {
                display: flex;
                align-items: center;
                align-self: center;
                justify-content: center;
                border-radius: 10%;
                font-family: 'Courier New', Courier, monospace;
                font-size: var(--row-sum-font-size);
                font-weight: 900;
                cursor: cell;
                opacity: 0.75;
                outline-style: none;
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
            }

            .diagonal-sum {
                height: var(--row-sum-size);
                width: var(--row-sum-size);
                border-left: 2px outset var(--secondary-colour);
                border-top: 2px outset var(--secondary-colour);
            }

            .column-sum {
                height: var(--row-sum-size);
                border-left: 2px outset var(--secondary-colour);
                border-right: 2px outset var(--secondary-colour);
            }

            .row-sum {
                width: var(--row-sum-size);
                border-top: 2px outset var(--secondary-colour);
                border-bottom: 2px outset var(--secondary-colour);
            }

            .diagonal-sum:focus,
            .diagonal-sum:hover,
            .column-sum:focus,
            .column-sum:hover,
            .row-sum:focus,
            .row-sum:hover {
                opacity: 1;
                background-color: var(--accent1);
                color: var(--primary-colour);
            }
        </style>
    </head>
    <body>
        <h1 id='game-name'>Sums</h1>

        <!-- Settings -->
        <details id='settings'>
            <summary id='settings-summary'>Settings</summary>
        </details>

        <!-- Page main body -->
        <!-- Difficulty settings -->
        <details>
            <summary id='difficulty-summary'>Difficulty settings</summary>

            <ul id='difficulty-settings'>
                <li>
                    <label for='difficulty-level' id='difficulty-level-label'>Difficulty level</label>
                    <input id='difficulty-level' type='number' min='1' max='9' value='3'>
                </li>

                <li>
                    <label for='difficulty-digits' id='difficulty-digits-label'>Number of digits</label>
                    <input id='difficulty-digits' type='number' min='2' max='10' value='10'>
                </li>

                <li class='tooltipParent'>
                    <label for='difficulty-compare' id='difficulty-compare-label'>Compare cells</label>
                    <input id='difficulty-compare' type='checkbox'>
                    <span id='difficulty-compare-tooltip' class='tooltip'>
                        Compare selected cell's neighbours' values with its value (only when digits number > 3).
                    </span>
                </li>
            </ul>
        </details>

        <!-- Rules -->
        <details>
            <summary id='rules-summary'>Rules</summary>

            <h3 id='rules-general'>General</h3>
            <p id='rules' tabindex='0'>
                   You have a 7 by 7 grid, the goal is to fill blank cells with digits (the number of digits can be configured in difficulty settings) taking into account the sum cells:
            </p>
            <ul id='rules-sums'>
                <li tabindex='0'>
                    <span>
                        <span class='cell-container sum'>33</span>
                        <p id='rules-sqr-sum'>Square sum: located inside the grid and shows the sum of the cells around it.</p>
                    </span>
                </li>
                <li tabindex='0'>
                    <span>
                        <span class='cell-container row-sum'>26</span>
                        <p id='rules-row-sum'>Row sum: located to the left of the grid and shows the sum of the cells in its row (except square sums).</p>
                    </span>
                </li>
                <li tabindex='0'>
                    <span>
                        <span class='cell-container column-sum'>11</span>
                        <p id='rules-col-sum'>Column sum: located above the grid and shows the sum of the cells in its column (except square sums).</p>
                    </span>
                </li>
                <li tabindex='0'>
                    <span>
                        <span class='cell-container diagonal-sum'>17</span>
                        <p id='rules-diag-sum'>Diagonal sum: located in the top-left corner of the grid and shows the sum of the cells in its diagonal (except square sums).</p>
                    </span>
                </li>
           </ul>

            <h3 id='rules-keyboard'>Keyboard controls</h3>
            <ul id='rules-keyboard-list'>
                <li>
                    <span id='rules-keyboard-arrow'>
                        <kbd>Arrow buttons</kbd>
                        <p> - move one cell left, right, up, and down</p>
                    </span>
                </li>
                <li>
                    <span id='rules-keyboard-home'>
                        <kbd>Home</kbd>
                        <p> - move to the first cell in the current row</p>
                    </span>
                </li>
                <li>
                    <span id='rules-keyboard-end'>
                        <kbd>End</kbd>
                        <p> - move to the last cell in the current row</p>
                    </span>
                </li>
                <li>
                    <span id='rules-keyboard-page-up'>
                        <kbd>Page Up</kbd>
                        <p> - move the the first cell in the current column</p>
                    </span>
                </li>
                <li>
                    <span id='rules-keyboard-page-down'>
                        <kbd>Page Down</kbd>
                        <p> - move to the last cell in the current column</p>
                    </span>
                </li>
            </ul>
        </details>

        <!-- Start button -->
        <button id='start'>Start</button>

        <!-- Restart window -->
        <div id='restart' class='modalWindow'>
            <p id='restart-question' class='modalText' tabindex='0'>
                Do you want to restart the game?
            </p>

            <div id='restart-buttons' class='modalButtonContainer'>
                <button id='restart-yes' class='modalButton'>
                    Yes
                </button>
                <button id='restart-cancel' class='modalButton'>
                    Cancel
                </button>
            </div>
        </div>

        <!-- Victory text -->
        <div id='grid-win' tabindex='0'>
            <span id='grid-victory' tabindex='0'>Victory!</span>
            
            <!-- End stats -->
            <table id='grid-win-stats'>
                <th id='grid-win-stats-label' colspan='2' tabindex='0'>
                    Statistics
                </th>

                <tr>
                    <td>
                        <span id='grid-win-time-label' tabindex='0'>Time (min:sec)</span>
                    </td>
                    <td>
                        <span id='grid-win-time' tabindex='0'>00:00</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span id='grid-win-mistakes-label' tabindex='0'>Mistakes</span>
                    </td>
                    <td>
                        <span id='grid-win-mistakes' tabindex='0'>0</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span id='grid-win-blanks-label' tabindex='0'>Cells filled</span>
                    </td>
                    <td>
                        <span id='grid-win-blanks' tabindex='0'>0</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span id='grid-win-digits-label' tabindex='0'>Digits number</span>
                    </td>
                    <td>
                        <span id='grid-win-digits' tabindex='0'>10</span>
                    </td>
                </tr>

                <tr>
                    <td>
                        <span id='grid-win-hints-label' tabindex='0'>Cells comparison</span>
                    </td>
                    <td>
                        <span id='grid-win-hints' tabindex='0'>-</span>
                    </td>
                </tr>
            </table>
        </div>

        <!-- Grid -->
        <div id='container'>
            <div id='grid'></div>
        </div>

        <p id='author' class='box' style='font-style: italic'>
            Made by Vitaly Pavlovich Ulyanov.
        </p>
        <!-- Автор — Виталий Павлович Ульянов. -->

        <script src='../resources/VitalLogic.js'></script>
        <script>
            // Elements
            /** @type {HTMLButtonElement} */
            let startButton = document.getElementById('start');
            /** @type {HTMLDivElement} */
            let restartWindow = document.getElementById('restart');
            /** @type {HTMLButtonElement} */
            let restartYes = document.getElementById('restart-yes');
            /** @type {HTMLButtonElement} */
            let restartCancel = document.getElementById('restart-cancel');
            /** @type {HTMLInputElement} */
            let difficultyLevel = document.getElementById('difficulty-level');
            /** @type {HTMLInputElement} */
            let difficultyDigits = document.getElementById('difficulty-digits');
            /** @type {HTMLInputElement} */
            let difficultyCompare = document.getElementById('difficulty-compare');
            /** @type {HTMLDivElement} */
            let grid = document.getElementById('grid');
            /** @type {HTMLSpanElement} */
            let win = document.getElementById('grid-win');
            /** @type {HTMLSpanElement} */
            let time = document.getElementById('grid-win-time');
            /** @type {HTMLSpanElement} */
            let mistakes = document.getElementById('grid-win-mistakes');
            /** @type {HTMLSpanElement} */
            let blanks = document.getElementById('grid-win-blanks');
            /** @type {HTMLSpanElement} */
            let digits = document.getElementById('grid-win-digits');
            /** @type {HTMLSpanElement} */
            let hints = document.getElementById('grid-win-hints');

            difficultyLevel.value = localStorage.getItem('difficulty') || 3;
            difficultyDigits.value = localStorage.getItem('digits') || 10;
            difficultyCompare.checked = localStorage.getItem('compare') === 'true';

            startButton.addEventListener('click', function (event) {
                if (gameInProcess) {
                    restartWindow.style.display = 'flex';
                    restartWindow.focus();
                } else {
                    fillGrid();
                }
            });

            restartYes.addEventListener('click', function (event) {
                restartWindow.style.display = 'none';
                fillGrid();
            });

            restartCancel.addEventListener('click', function (event) {
                restartWindow.style.display = 'none';
            });

            difficultyLevel.addEventListener('change', function (event) {
                this.value = clamp(1, +this.value, 9);
                localStorage.setItem('difficulty', this.value);
                fillGrid();
            });

            difficultyDigits.addEventListener('change', function (event) {
                this.value = clamp(2, +this.value, 10);
                localStorage.setItem('digits', this.value);
                difficultyCompare.disabled = this.value < 4;
                fillGrid();
            });

            difficultyCompare.addEventListener('change', function (event) {
                localStorage.setItem('compare', this.checked);
                fillGrid();
            });

            // Variables
            /** @type {boolean} */
            let gameInProcess = false;
            /** @type {number} */
            let mistakesCount;
            /** @type {number} */
            let blanksCount;
            /** @type {number} */
            let digitsCount;
            /** @type {number} */
            let difficulty;
            /** @type {number} */
            let timerStart;
            /** @type {number} */
            let timerEnd;

            function fillGrid() {
                // Clean up before starting new game
                while (grid.hasChildNodes()) {
                    grid.lastChild.remove();
                }

                difficulty = +difficultyLevel.value / 10;
                digitsCount = +difficultyDigits.value;
                restartWindow.style.display = 'none';
                win.style.display = 'none';
                timerStart = Date.now();
                mistakesCount = 0;
                blanksCount = 0;

                //#region Prefill the grid with cell containers
                for (let y = 0; y < 8; y++) {
                    /** @type {HTMLDivElement} */
                    let row = grid.appendChild(
                        document.createElement('div')
                    );
                    row.classList.add('row')

                    for (let x = 0; x < 8; x++) {
                        /** @type {HTMLInputElement | HTMLSpanElement} */
                        let cell;

                        if (x > 0 && y > 0) {
                            // Input or sum
                            if (x % 2 !== 0 || y % 2 !== 0) {
                                cell = row.appendChild(
                                    document.createElement('input')
                                );
                                cell.classList.add('cell-container', 'cell');
                            } else {
                                cell = row.appendChild(
                                    document.createElement('span')
                                );
                                cell.classList.add('cell-container', 'sum');
                            }
                        } else {
                            cell = row.appendChild(
                                document.createElement('span')
                            );

                            if (x === 0 && y > 0) {
                                cell.classList.add('cell-container', 'row-sum');
                                cell.addEventListener('mouseenter', function (event) { this.focus(); });
                                cell.addEventListener('mouseleave', function (event) { this.blur(); });
                                cell.addEventListener('focusin', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(i, y);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.add('highlight');
                                        }
                                    }
                                });
                                cell.addEventListener('focusout', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(i, y);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.remove('highlight');
                                        }
                                    }
                                });
                            } else if (x > 0 && y === 0) {
                                cell.classList.add('cell-container', 'column-sum');
                                cell.addEventListener('mouseenter', function (event) { this.focus(); });
                                cell.addEventListener('mouseleave', function (event) { this.blur(); });
                                cell.addEventListener('focusin', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(x, i);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.add('highlight');
                                        }
                                    }
                                });
                                cell.addEventListener('focusout', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(x, i);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.remove('highlight');
                                        }
                                    }
                                });
                            } else {
                                cell.classList.add('cell-container', 'diagonal-sum');
                                cell.addEventListener('mouseenter', function (event) { this.focus(); });
                                cell.addEventListener('mouseleave', function (event) { this.blur(); });
                                cell.addEventListener('focusin', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(i, i);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.add('highlight');
                                        }
                                    }
                                });
                                cell.addEventListener('focusout', function (event) {
                                    for (let i = 1; i < 8; i++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(i, i);

                                        if (c && !c.classList.contains('sum')) {
                                            c.classList.remove('highlight');
                                        }
                                    }
                                });
                            }
                        }

                        cell.id = `${x};${y}`;
                        cell.dataset.x = x;
                        cell.dataset.y = y;
                        cell.tabIndex = 0;
                        cell.addEventListener('keydown', function (event) {
                            processControls(event, x, y);
                        });
                    }
                }
                //#endregion

                //#region Fill input cells
                for (let y = 1; y < 8; y++) {
                    for (let x = 1; x < 8; x++) {
                        /** @type {HTMLInputElement} */
                        let cell = getCell(x, y);
                        if (!cell) continue;

                        // Determine if it's input or sum cell
                        if (x % 2 !== 0 || y % 2 !== 0) {
                            /** @type {number} */
                            let random = Math.floor(Math.random() * digitsCount);

                            cell.required = true;
                            cell.pattern = random;
                            cell.maxLength = 1;
                            cell.title = '';

                            cell.addEventListener('click', function (event) {
                                this.select();
                            });
                            cell.addEventListener('keyup', function (event) {
                                if (this.value !== this.pattern) {
                                    this.readOnly = false;
                                }
                            });
                            cell.addEventListener('input', function (event) {
                                this.readOnly = true;

                                if (this.value === this.pattern) {
                                    checkWin();
                                } else {
                                    if (this.value !== '') {
                                        mistakesCount++;
                                        this.select();
                                    }
                                }
                            });
                            cell.addEventListener('focusin', function (event) {
                                    if (difficultyCompare.checked && digitsCount > 3) {
                                        for (let dy = -1; dy < 2; dy++) {
                                            for (let dx = -1; dx < 2; dx++) {
                                                if (dy === 0 && dx === 0) continue;

                                                /** @type {HTMLInputElement} */
                                                let neighbour = getCell(x + dx, y + dy);

                                                if (neighbour
                                                    && !neighbour.classList.contains('sum')
                                                    && !neighbour.classList.contains('row-sum')
                                                    && !neighbour.classList.contains('column-sum')
                                                ) {
                                                    /** @type {number} */
                                                    let c = +this.pattern;
                                                    /** @type {number} */
                                                    let n = +neighbour.pattern;

                                                    neighbour.placeholder =
                                                        n > c ? '>' :
                                                            n < c ? '<' :
                                                                '=';
                                                }
                                            }
                                        }
                                    }
                                });
                            cell.addEventListener('focusout', function (event) {
                                if (difficultyCompare.checked && digitsCount > 3) {
                                    for (let dy = -1; dy < 2; dy++) {
                                        for (let dx = -1; dx < 2; dx++) {
                                            if (dy === 0 && dx === 0) continue;
                                            
                                            /** @type {HTMLInputElement} */
                                            let neighbour = getCell(x + dx, y + dy);

                                            if (neighbour
                                                && !neighbour.classList.contains('sum')
                                                && !neighbour.classList.contains('row-sum')
                                                && !neighbour.classList.contains('column-sum')
                                            ) {
                                                neighbour.placeholder = '';
                                            }
                                        }
                                    }
                                }
                            });
                        } else {
                            cell.addEventListener('mouseenter', function (event) { this.focus(); });
                            cell.addEventListener('mouseleave', function (event) { this.blur(); });
                            cell.addEventListener('focusin', function (event) {
                                for (let dy = -1; dy < 2; dy++) {
                                    for (let dx = -1; dx < 2; dx++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(x + dx, y + dy);

                                        if (c) {
                                            c.classList.add('highlight');
                                        }
                                    }
                                }
                            });
                            cell.addEventListener('focusout', function (event) {
                                for (let dy = -1; dy < 2; dy++) {
                                    for (let dx = -1; dx < 2; dx++) {
                                        /** @type {HTMLInputElement} */
                                        let c = getCell(x + dx, y + dy);

                                        if (c) {
                                            c.classList.remove('highlight');
                                        }
                                    }
                                }
                            });
                        }
                    }
                }
                //#endregion

                //#region Fill central sums
                for (let s of grid.getElementsByClassName('sum')) {
                    /** @type {number} */
                    let sum = 0;

                    for (let y = -1; y < 2; y++) {
                        for (let x = -1; x < 2; x++) {
                            /** @type {HTMLInputElement} */
                            let cell = getCell(
                                +s.dataset.x + x,
                                +s.dataset.y + y
                            );

                            if (cell && cell !== s) {
                                sum += +cell.pattern;
                            }
                        }
                    }

                    s.textContent = sum;
                }
                //#endregion

                //#region Fill diagonal sum
                /** @type {number} */
                let diagSum = 0;

                for (let i = 1; i < 8; i++) {
                    /** @type {HTMLInputElement} */
                    let cell = getCell(i, i);

                    if (cell && !cell.classList.contains('sum')) {
                        diagSum += +cell.pattern;
                    }
                }

                /** @type {HTMLSpanElement} */
                let diagSumCell = getCell(0, 0);

                if (diagSumCell) {
                    diagSumCell.textContent = diagSum;
                }
                //#endregion

                //#region Fill row & columns sums
                for (let i = 1; i < 8; i++) {
                    // --- Rows ---
                    /** @type {number} */
                    let rowSum = 0;

                    for (let x = 1; x < 8; x++) {
                        /** @type {HTMLInputElement} */
                        let cell = getCell(x, i);

                        if (cell && !cell.classList.contains('sum')) {
                            rowSum += +cell.pattern;
                        }
                    }

                    /** @type {HTMLSpanElement} */
                    let rowSumCell = getCell(0, i);

                    if (rowSumCell) {
                        rowSumCell.textContent = rowSum;
                    }

                    // --- Columns ---
                    /** @type {number} */
                    let colSum = 0;

                    for (let y = 1; y < 8; y++) {
                        /** @type {HTMLInputElement} */
                        let cell = getCell(i, y);

                        if (cell && !cell.classList.contains('sum')) {
                            colSum += +cell.pattern;
                        }
                    }

                    /** @type {HTMLSpanElement} */
                    let colSumCell = getCell(i, 0);

                    if (colSumCell) {
                        colSumCell.textContent = colSum;
                    }
                }
                //#endregion
                
                //#region Reveal random ordinary cells
                /** @type {HTMLInputElement[]} */
                let cells = Array.from(grid.getElementsByClassName('cell')).filter(
                    (c) => !c.classList.contains('sum')
                );
                
                /** @type {number} */
                let maxBlanks = cells.length - 7;
                blanksCount = cells.length;

                cells.forEach((c, i) => {
                    if (blanksCount < 6) return;

                    if (Math.random() > difficulty) {
                        c.value = c.pattern;
                        c.readOnly = true;
                        blanksCount--;
                    }
                });

                while (blanksCount > maxBlanks) {
                    /** @type {number} */
                    let random = Math.floor(Math.random() * cells.length);

                    if (cells[random].readOnly === false) {
                        cells[random].value = cells[random].pattern;
                        cells[random].readOnly = true;
                        cells.splice(random, 1);
                        blanksCount--;
                    }
                }
                //#endregion

                /** @type {HTMLInputElement} */
                let centre = getCell(4, 4);
                if (centre) {
                    centre.focus();
                }

                gameInProcess = true;
            }

            /**
             * @param {number} min
             * @param {number} value
             * @param {number} max
            */
            function clamp(min, value, max) {
                return value > max
                    ? max
                    : value < min
                        ? min
                        : value;
            }

            /**
             * @param {string | number} x
             * @param {string | number} y
            */
            function getCell(x, y) {
                return document.getElementById(`${x};${y}`);
            }

            /**
             * @param {KeyboardEvent} event
             * @param {number} x
             * @param {number} y
            */
            function processControls(event, x, y) {
                /** @type {{
                 * key: string,
                 * x: number,
                 * y: number
                }[]} */
                let directions = [
                    {key: 'ArrowDown', x: x, y: y + 1},
                    {key: 'ArrowUp', x: x, y: y - 1},
                    {key: 'ArrowLeft', x: x - 1, y: y},
                    {key: 'ArrowRight', x: x + 1, y: y},
                    {key: 'Home', x: 1, y: y},
                    {key: 'End', x: 7, y: y},
                    {key: 'PageUp', x: x, y: 1},
                    {key: 'PageDown', x: x, y: 7}
                ];

                for (let d of directions) {
                    if (event.key === d.key) {
                        event.preventDefault();

                        let nextCell = getCell(d.x, d.y);

                        if (nextCell) {
                            nextCell.focus();
                        }
                        break;
                    }
                }
            }

            function checkWin() {
                /** @type {boolean} */
                let allCorrect = true;
                /** @type {HTMLInputElement[]} */
                let inputs = grid.getElementsByClassName('cell');
                
                for (let i of inputs) {
                    if (i.readOnly === false
                        && i.value !== i.pattern
                ) {
                        allCorrect = false;
                        return false;
                    }
                }

                if (allCorrect) {
                    if (win.style.display === 'flex') return true;

                    win.style.display = 'flex';
                    timerEnd = Date.now();
                    gameInProcess = false;

                    let date = new Date(timerEnd - timerStart);
                    let min = date.getMinutes();
                    let sec = date.getSeconds();

                    time.textContent = `${
                        min > 9 ? min : `0${min}`
                    }:${
                        sec > 9 ? sec : `0${sec}`
                    }`;
                    mistakes.textContent = mistakesCount;
                    blanks.textContent = blanksCount;
                    digits.textContent = digitsCount;
                    hints.textContent = (difficultyCompare.checked && digitsCount > 3)
                        ? '+'
                        : '-';

                    win.focus();
                }

                return allCorrect;
            }

            generateLanguagesList([
                {
                    name: 'English [Vitaly Ulyanov]',
                    langTags: ['en', 'en-AU', 'en-BZ', 'en-CA', 'en-CB', 'en-GB', 'en-IE', 'en-JM', 'en-NZ', 'en-PH', 'en-TT', 'en-US', 'en-ZA', 'en-ZW'],
                    elements: [
                        {
                            "id": "game-name",
                            "childNodesTexts": [
                                "Sums"
                            ]
                        },
                        {
                            "id": "settings-summary",
                            "childNodesTexts": [
                                "Settings"
                            ]
                        },
                        {
                            "id": "fontLabel",
                            "childNodesTexts": [
                                "Font"
                            ]
                        },
                        {
                            "id": "fontInput",
                            "childNodesTexts": [],
                            "placeholder": "Type a font's name and press Enter"
                        },
                        {
                            "id": "primLabel",
                            "childNodesTexts": [
                                "Background colour"
                            ]
                        },
                        {
                            "id": "secLabel",
                            "childNodesTexts": [
                                "Text colour"
                            ]
                        },
                        {
                            "id": "acc1Label",
                            "childNodesTexts": [
                                "Accent colour 1"
                            ]
                        },
                        {
                            "id": "acc2Label",
                            "childNodesTexts": [
                                "Accent colour 2"
                            ]
                        },
                        {
                            "id": "loadLabel",
                            "childNodesTexts": [
                                "📁 Load colours"
                            ]
                        },
                        {
                            "id": "saveColoursButton",
                            "childNodesTexts": [
                                "💾 Save colours"
                            ]
                        },
                        {
                            "id": "exportLang",
                            "childNodesTexts": [
                                "🌐 Export texts for translation"
                            ]
                        },
                        {
                            "id": "difficulty-summary",
                            "childNodesTexts": [
                                "Difficulty settings"
                            ]
                        },
                        {
                            "id": "difficulty-level-label",
                            "childNodesTexts": [
                                "Difficulty level"
                            ]
                        },
                        {
                            "id": "difficulty-digits-label",
                            "childNodesTexts": [
                                "Number of digits"
                            ]
                        },
                        {
                            "id": "difficulty-compare-label",
                            "childNodesTexts": [
                                "Compare cells"
                            ]
                        },
                        {
                            "id": "difficulty-compare-tooltip",
                            "childNodesTexts": [
                                "Compare selected cell's neighbours' values with its value (only when digits number > 3)."
                            ]
                        },
                        {
                            "id": "rules-summary",
                            "childNodesTexts": [
                                "Rules"
                            ]
                        },
                        {
                            "id": "rules-general",
                            "childNodesTexts": [
                                "General"
                            ]
                        },
                        {
                            "id": "rules",
                            "childNodesTexts": [
                                "You have a 7 by 7 grid, the goal is to fill blank cells with digits (the number of digits can be configured in difficulty settings) taking into account the sum cells:"
                            ]
                        },
                        {
                            "id": "rules-sqr-sum",
                            "childNodesTexts": [
                                "Square sum: located inside the grid and shows the sum of the cells around it."
                            ]
                        },
                        {
                            "id": "rules-row-sum",
                            "childNodesTexts": [
                                "Row sum: located to the left of the grid and shows the sum of the cells in its row (except square sums)."
                            ]
                        },
                        {
                            "id": "rules-col-sum",
                            "childNodesTexts": [
                                "Column sum: located above the grid and shows the sum of the cells in its column (except square sums)."
                            ]
                        },
                        {
                            "id": "rules-diag-sum",
                            "childNodesTexts": [
                                "Diagonal sum: located in the top-left corner of the grid and shows the sum of the cells in its diagonal (except square sums)."
                            ]
                        },
                        {
                            "id": "rules-keyboard",
                            "childNodesTexts": [
                                "Keyboard controls"
                            ]
                        },
                        {
                            "id": "rules-keyboard-arrow",
                            "childNodesTexts": [
                                "Arrow buttons",
                                "- move one cell left, right, up, and down"
                            ]
                        },
                        {
                            "id": "rules-keyboard-home",
                            "childNodesTexts": [
                                "Home",
                                "- move to the first cell in the current row"
                            ]
                        },
                        {
                            "id": "rules-keyboard-end",
                            "childNodesTexts": [
                                "End",
                                "- move to the last cell in the current row"
                            ]
                        },
                        {
                            "id": "rules-keyboard-page-up",
                            "childNodesTexts": [
                                "Page Up",
                                "- move the the first cell in the current column"
                            ]
                        },
                        {
                            "id": "rules-keyboard-page-down",
                            "childNodesTexts": [
                                "Page Down",
                                "- move to the last cell in the current column"
                            ]
                        },
                        {
                            "id": "start",
                            "childNodesTexts": [
                                "Start"
                            ]
                        },
                        {
                            "id": "restart-question",
                            "childNodesTexts": [
                                "Do you want to restart the game?"
                            ]
                        },
                        {
                            "id": "restart-yes",
                            "childNodesTexts": [
                                "Yes"
                            ]
                        },
                        {
                            "id": "restart-cancel",
                            "childNodesTexts": [
                                "Cancel"
                            ]
                        },
                        {
                            "id": "grid-victory",
                            "childNodesTexts": [
                                "Victory!"
                            ]
                        },
                        {
                            "id": "grid-win-stats-label",
                            "childNodesTexts": [
                                "Statistics"
                            ]
                        },
                        {
                            "id": "grid-win-time-label",
                            "childNodesTexts": [
                                "Time (min:sec)"
                            ]
                        },
                        {
                            "id": "grid-win-mistakes-label",
                            "childNodesTexts": [
                                "Mistakes"
                            ]
                        },
                        {
                            "id": "grid-win-blanks-label",
                            "childNodesTexts": [
                                "Cells filled"
                            ]
                        },
                        {
                            "id": "grid-win-digits-label",
                            "childNodesTexts": [
                                "Digits number"
                            ]
                        },
                        {
                            "id": "grid-win-hints-label",
                            "childNodesTexts": [
                                "Cells comparison"
                            ]
                        },
                        {
                            "id": "author",
                            "childNodesTexts": [
                                "Made by Vitaly Pavlovich Ulyanov."
                            ]
                        },
                        {
                            "id": "fullscreenButton",
                            "childNodesTexts": [
                                "▲",
                                "Fullscreen"
                            ]
                        }
                    ]
                },
                {
                    name: 'Русский [Виталий Ульянов]',
                    langTags: ['ru', 'ru-RU'],
                    elements: [
                        {
                            "id": "game-name",
                            "childNodesTexts": [
                                "Суммы"
                            ]
                        },
                        {
                            "id": "settings-summary",
                            "childNodesTexts": [
                                "Настройки"
                            ]
                        },
                        {
                            "id": "fontLabel",
                            "childNodesTexts": [
                                "Шрифт"
                            ]
                        },
                        {
                            "id": "fontInput",
                            "childNodesTexts": [],
                            "placeholder": "Введите название шрифта и нажмите Enter"
                        },
                        {
                            "id": "primLabel",
                            "childNodesTexts": [
                                "Цвет фона"
                            ]
                        },
                        {
                            "id": "secLabel",
                            "childNodesTexts": [
                                "Цвет текста"
                            ]
                        },
                        {
                            "id": "acc1Label",
                            "childNodesTexts": [
                                "Акцентный цвет 1"
                            ]
                        },
                        {
                            "id": "acc2Label",
                            "childNodesTexts": [
                                "Акцентный цвет 2"
                            ]
                        },
                        {
                            "id": "loadLabel",
                            "childNodesTexts": [
                                "📁 Загрузить цвета"
                            ]
                        },
                        {
                            "id": "saveColoursButton",
                            "childNodesTexts": [
                                "💾 Сохранить цвета"
                            ]
                        },
                        {
                            "id": "exportLang",
                            "childNodesTexts": [
                                "🌐 Экспортировать тексты для перевода"
                            ]
                        },
                        {
                            "id": "difficulty-summary",
                            "childNodesTexts": [
                                "Настройки сложности"
                            ]
                        },
                        {
                            "id": "difficulty-level-label",
                            "childNodesTexts": [
                                "Уровень сложности"
                            ]
                        },
                        {
                            "id": "difficulty-digits-label",
                            "childNodesTexts": [
                                "Количество цифр"
                            ]
                        },
                        {
                            "id": "difficulty-compare-label",
                            "childNodesTexts": [
                                "Сравнивать клетки"
                            ]
                        },
                        {
                            "id": "difficulty-compare-tooltip",
                            "childNodesTexts": [
                                "Сравнивать значения соседей выделенной клетки с её значением (только при количестве цифр > 3)."
                            ]
                        },
                        {
                            "id": "rules-summary",
                            "childNodesTexts": [
                                "Правила"
                            ]
                        },
                        {
                            "id": "rules-general",
                            "childNodesTexts": [
                                "Общее"
                            ]
                        },
                        {
                            "id": "rules",
                            "childNodesTexts": [
                                "Перед Вами сетка 7 на 7, цель — заполнить пустые клетки цифрами (количество цифр можно задать в настройках сложности), учитывая значения в клетках сумм:"
                            ]
                        },
                        {
                            "id": "rules-sqr-sum",
                            "childNodesTexts": [
                                "Сумма квадрата: находится внутри сетки и показывает сумму клеток вокруг неё."
                            ]
                        },
                        {
                            "id": "rules-row-sum",
                            "childNodesTexts": [
                                "Сумма строки: находится слева от сетки и показывает сумму клеток в своей строке (кроме сумм квадратов)."
                            ]
                        },
                        {
                            "id": "rules-col-sum",
                            "childNodesTexts": [
                                "Сумма столбца: находится над сеткой и показывает сумму клеток в своём столбце (кроме сумм квадратов)."
                            ]
                        },
                        {
                            "id": "rules-diag-sum",
                            "childNodesTexts": [
                                "Сумма диагонали: находится в левом верхнем углу сетки и показывает сумму клеток в своей диагонали (кроме сумм квадратов)."
                            ]
                        },
                        {
                            "id": "rules-keyboard",
                            "childNodesTexts": [
                                "Управление с помощью клавиатуры"
                            ]
                        },
                        {
                            "id": "rules-keyboard-arrow",
                            "childNodesTexts": [
                                "Кнопки со стрелками",
                                "- движение на одну клетку влево, вправо, вверх и вниз"
                            ]
                        },
                        {
                            "id": "rules-keyboard-home",
                            "childNodesTexts": [
                                "Home",
                                "- переход к первой клетке в текущей строке"
                            ]
                        },
                        {
                            "id": "rules-keyboard-end",
                            "childNodesTexts": [
                                "End",
                                "- переход к последней клетке в текущей строке"
                            ]
                        },
                        {
                            "id": "rules-keyboard-page-up",
                            "childNodesTexts": [
                                "Page Up",
                                "- переход к первой клетке в текущем столбце"
                            ]
                        },
                        {
                            "id": "rules-keyboard-page-down",
                            "childNodesTexts": [
                                "Page Down",
                                "- переход к последней клетке в текущем столбце"
                            ]
                        },
                        {
                            "id": "start",
                            "childNodesTexts": [
                                "Начать"
                            ]
                        },
                        {
                            "id": "restart-question",
                            "childNodesTexts": [
                                "Вы хотите перезапустить игру?"
                            ]
                        },
                        {
                            "id": "restart-yes",
                            "childNodesTexts": [
                                "Да"
                            ]
                        },
                        {
                            "id": "restart-cancel",
                            "childNodesTexts": [
                                "Отмена"
                            ]
                        },
                        {
                            "id": "grid-victory",
                            "childNodesTexts": [
                                "Победа!"
                            ]
                        },
                        {
                            "id": "grid-win-stats-label",
                            "childNodesTexts": [
                                "Статистика"
                            ]
                        },
                        {
                            "id": "grid-win-time-label",
                            "childNodesTexts": [
                                "Время (мин:сек)"
                            ]
                        },
                        {
                            "id": "grid-win-mistakes-label",
                            "childNodesTexts": [
                                "Ошибок"
                            ]
                        },
                        {
                            "id": "grid-win-blanks-label",
                            "childNodesTexts": [
                                "Клеток заполнено"
                            ]
                        },
                        {
                            "id": "grid-win-digits-label",
                            "childNodesTexts": [
                                "Количество цифр"
                            ]
                        },
                        {
                            "id": "grid-win-hints-label",
                            "childNodesTexts": [
                                "Сравнение клеток"
                            ]
                        },
                        {
                            "id": "author",
                            "childNodesTexts": [
                                "Автор — Виталий Павлович Ульянов."
                            ]
                        },
                        {
                            "id": "fullscreenButton",
                            "childNodesTexts": [
                                "▲",
                                "Полный экран"
                            ]
                        }
                    ]
                }
            ]);
        </script>
    </body>
</html>
