<!DOCTYPE html>
<html lang='en'>
    <head>
        <meta charset='utf-8' />
        <meta http-equiv='X-UA-Compatible' content='IE=edge' />
        <title>Crosswords</title>
        <meta name='viewport' content='width=device-width, initial-scale=1' />
        <link rel='stylesheet' href='../resources/VitalStyle.css' />

        <style>
            :root {
                --cell-size: 52px;
                --cell-border: calc(var(--cell-size) * 0.05);
                --cell-font: calc(var(--cell-size) * 0.65);
                --cell-radius: 5%;
                --num-border: calc(var(--cell-border) * 1.5);
                --gap-size: calc(var(--cell-size) * 0.04);
            }

            .grid {
                display: flex;
                flex-direction: column;
                row-gap: var(--gap-size);
                overflow-x: auto;
                overflow-y: hidden;
                padding: 4px;
                cursor: crosshair;
            }

            .row {
                display: flex;
                margin: 0;
                column-gap: var(--gap-size);
                width: fit-content;
            }

            .cell {
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: var(--accent2);
                border: var(--cell-border) solid var(--accent1);
                border-radius: var(--cell-radius);
                border-style: solid;
                margin: 0;
                height: var(--cell-size);
                width: var(--cell-size);
                font-size: var(--cell-font);
                font-weight: 600;
                transition: all 1.5s ease-in;
            }

            .cell:focus,
            .cell:hover {
                border-color: var(--secondary-colour);
                transition: border-color 0.1s ease;
            }

            .empty {
                opacity: 0.2;
                border-color: var(--accent1);
                background-color: var(--primary-colour);
                transition: opacity 1.5s ease-in;
            }

            .empty:focus,
            .empty:hover {
                opacity: 0.7;
                border-color: var(--accent1);
                transition:
                    all 0.1s ease,
                    background-color 0.5s ease-in;
            }

            .cell-input {
                background-color: transparent;
                border-style: none;
                font-size: var(--cell-font);
                font-weight: 600;
                text-align: center;
                height: 100%;
                width: 100%;
                transition: all 1s ease-in;
            }

            .cell-input::selection {
                background-color: transparent;
                color: var(--accent2);
                text-shadow: 2px 2px var(--secondary-colour);
            }

            .cell-input:valid {
                background-color: var(--secondary-colour);
                color: var(--primary-colour);
                transition: all 1.2s ease-in;
            }

            .cell-input:focus,
            .cell-input:hover {
                background-color: var(--accent1);
                color: var(--primary-colour);
                transition: none;
            }

            .cell-input:valid:focus,
            .cell-input:valid:hover {
                background-color: var(--primary-colour);
                color: var(--secondary-colour);
                transition: none;
            }

            .cell-number {
                background-color: transparent;
                border-style: none;
            }

            .number {
                background-color: var(--accent1);
                color: var(--primary-colour);
                border-style: none;
                font-family: 'Courier New', Courier, monospace;
                font-size: calc(var(--cell-font) * 0.75);
                font-weight: 900;
                cursor: pointer;
                width: 100%;
                height: 100%;
                transition: all 0.5s ease;
            }

            .number:focus,
            .number:hover {
                background-color: var(--primary-colour);
                border: var(--num-border) solid var(--accent1);
                color: var(--secondary-colour);
                outline-style: none;
                transition: background-color 0.5s ease;
            }

            .vertical {
                align-items: end;
                border-radius: 50% 50% var(--cell-radius) var(--cell-radius);
                border-bottom: var(--num-border) solid var(--secondary-colour);
            }

            .horizontal {
                justify-content: end;
                border-radius: 50% var(--cell-radius) var(--cell-radius) 50%;
                border-right: var(--num-border) solid var(--secondary-colour);
            }

            .question-tooltip {
                background-color: var(--primary-colour);
                color: var(--secondary-colour);
                border-color: var(--secondary-colour);
                font-size: 1.15rem;
                max-width: 95vw;
                left: 50%;
                transform: translateX(-50%);
            }

            .question-tooltip::before {
                display: none;
            }

            .question-button {
                border-style: none;
                padding-inline: 4px;
            }

            #loadButton {
                max-width: 100%;
            }

            #questions {
                display: flex;
                flex-wrap: wrap;
            }

            #questions-ver,
            #questions-hor {
                flex-grow: 1;
                font-size: 1.2em;
                font-weight: 600;
                min-width: 50%;
            }

            #questions-ver-name,
            #questions-hor-name {
                font-style: italic;
                font-size: 1.1em;
                font-weight: 600;
                border-bottom: var(--cell-border) solid var(--accent1);
            }
        </style>
    </head>
    <body>
        <h1>Crosswords</h1>

        <!-- Settings -->
        <details id='settings'>
            <summary>Settings</summary>
        </details>

        <!-- Page main body -->

        <!-- Load button -->
        <div class='box' style='display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between'>
            <label for='loadButton' style='flex-grow: 1; cursor: pointer'>&#128193; Открыть кроссворд</label>
            <input id='loadButton' type='file' accept='.json' style='cursor: pointer' onchange='loadCrossword()' />
        </div>

        <!-- Crossword name -->
        <h2 id='crosswordName'>...</h2>

        <!-- Questions -->
        <div id='questions'>
            <div id='questions-ver'>
                <span id='questions-ver-name' tabindex='0'>
                    Vertical
                </span>
                <ol id='questions-ver-list'></ol>
            </div>

            <div id='questions-hor'>
                <span id='questions-hor-name' tabindex='0'>
                    Horizontal
                </span>
                <ol id='questions-hor-list'></ol>
            </div>
        </div>

        <!-- Grid -->
        <div id='crossword' class='grid'></div>

        <p id='author' class='box' style='font-style: italic'>
            Made by Vitaly Pavlovich Ulyanov.
        </p>
        <!-- Автор — Виталий Павлович Ульянов. -->

        <script src='../resources/VitalLogic.js'></script>
        <script>
            // Elements
            /** @type {HTMLDivElement} */
            let grid = document.getElementById('crossword');
            /** @type {HTMLInputElement} */
            let loadButton = document.getElementById('loadButton');
            /** @type {HTMLHeadingElement} */
            let crosswordName = document.getElementById('crosswordName');
            /** @type {HTMLOListElement} */
            let verQuestions = document.getElementById('questions-ver-list');
            /** @type {HTMLOListElement} */
            let horQuestions = document.getElementById('questions-hor-list');

            // Variables
            /**
             * @typedef {Object} Word
             * @property {string} word
             * @property {string} description
             * @property {boolean} vertical
             * @property {number} x
             * @property {number} y
            */
            /** @type {Word[]} */
            let words = [
                {
                    "word": "pebble",
                    "description": "Камушек",
                    "x": 1,
                    "y": 0,
                    "vertical": true
                },
                {
                    "word": "dictum",
                    "description": "Изречение",
                    "x": 7,
                    "y": 0,
                    "vertical": true
                },
                {
                    "word": "extremist",
                    "description": "Крайний",
                    "x": 0,
                    "y": 2,
                    "vertical": false
                },
                {
                    "word": "manual",
                    "description": "Руководство",
                    "x": 12,
                    "y": 2,
                    "vertical": true
                },
                {
                    "word": "bias",
                    "description": "Предвзятость",
                    "x": 0,
                    "y": 4,
                    "vertical": false
                },
                {
                    "word": "exquisite",
                    "description": "Изысканный",
                    "x": 5,
                    "y": 4,
                    "vertical": true
                },
                {
                    "word": "equation",
                    "description": "Уравнение",
                    "x": 4,
                    "y": 5,
                    "vertical": false
                },
                {
                    "word": "decimal",
                    "description": "Десятичный",
                    "x": 1,
                    "y": 7,
                    "vertical": true
                },
                {
                    "word": "denouement",
                    "description": "Завершение",
                    "x": 0,
                    "y": 8,
                    "vertical": false
                },
                {
                    "word": "curve",
                    "description": "Кривая [сущ.]",
                    "x": 11,
                    "y": 8,
                    "vertical": true
                },
                {
                    "word": "descent",
                    "description": "Происхождение",
                    "x": 2,
                    "y": 10,
                    "vertical": false
                },
                {
                    "word": "suppress",
                    "description": "Подавлять",
                    "x": 8,
                    "y": 11,
                    "vertical": true
                },
                {
                    "word": "expunge",
                    "description": "Вычёркивать, исключать",
                    "x": 4,
                    "y": 13,
                    "vertical": false
                },
                {
                    "word": "proffer",
                    "description": "Предлагать",
                    "x": 3,
                    "y": 14,
                    "vertical": true
                },
                {
                    "word": "percept",
                    "description": "Объект восприятия",
                    "x": 2,
                    "y": 15,
                    "vertical": false
                },
                {
                    "word": "frenzy",
                    "description": "Безумие, бешенство",
                    "x": 6,
                    "y": 18,
                    "vertical": true
                },
                {
                    "word": "fossil",
                    "description": "Ископаемый",
                    "x": 5,
                    "y": 19,
                    "vertical": false
                },
                {
                    "word": "forebear",
                    "description": "Предок",
                    "x": 0,
                    "y": 21,
                    "vertical": false
                }
            ];
            /** @type {number} */
            let xMax = 0;
            /** @type {number} */
            let yMax = 0;
            /** @type {boolean} */
            let isFlowVertical = false;
            /** @type {HTMLButtonElement} */
            let lastNumber = undefined;

            /**
             * @param {Word} word
            */
            function isWordOutOfBounds(word) {
                return (
                    word.x < 0
                    || word.y < 0
                    || word.x > xMax
                    || word.y > yMax
                );
            }

            async function loadCrossword() {
                await loadButton.files[0].text().then((content) => {
                    try {
                        let data = JSON.parse(content);
                        if (data) {
                            words = data;
                            crosswordName.textContent = loadButton.files[0].name.replace('.json', '');
                            fillGrid();
                        }
                    } catch (error) {
                        alert(`Ошибка при чтении файла или создании кроссворда: ${error}`);
                    }
                });
            }

            /**
             * @param {Word} word
             * @param {HTMLButtonElement} num
            */
            function setUpQuestion(word, num) {
                /** @type {HTMLOListElement} */
                let target = word.vertical
                    ? verQuestions
                    : horQuestions;
                
                let item = target.appendChild(
                    document.createElement('li')
                ).appendChild(
                    document.createElement('button')
                );

                item.classList.add('question-button');
                item.textContent = word.description + ` [${word.word.length}].`;

                item.addEventListener('click', function (event) {
                    isFlowVertical = word.vertical;
                    lastNumber = num;

                    /** @type {HTMLInputElement} */
                    let next = document.getElementById(
                        `${
                            word.vertical ? word.x : word.x + 1
                        };${
                            word.vertical ? word.y + 1 : word.y
                        }`
                    );

                    if (next) {
                        next.focus();
                        next.select();
                    }
                });
            }

            /**
             * @param {Word} word
             * @param {number} num
            */
            function setUpNumber(word, num) {
                /** @type {HTMLDivElement} */
                let cell = grid.children[word.y].children[word.x];
                cell.classList.remove('empty');
                cell.classList.add('cell-number')

                let button = cell.appendChild(
                    document.createElement('button')
                );

                button.id = `${word.x};${word.y}`;
                button.tabIndex = 1;
                button.classList.add(
                    'number',
                    'tooltipParent',
                    word.vertical
                        ? 'vertical'
                        : 'horizontal'
                );
                button.textContent = num;

                button.addEventListener('click', function (event) {
                    isFlowVertical = word.vertical;
                    lastNumber = this;

                    /** @type {HTMLInputElement} */
                    let next = document.getElementById(
                        `${
                            word.vertical ? word.x : word.x + 1
                        };${
                            word.vertical ? word.y + 1 : word.y
                        }`
                    );

                    if (next) next.select();
                });

                setUpQuestion(word, button);

                let tooltip = button.appendChild(
                    document.createElement('span')
                );
                tooltip.classList.add('tooltip', 'question-tooltip');
                tooltip.textContent = `№${num}. ${word.description} [${
                    word.word.length
                }]`;
            }

            /**
             * @param {HTMLDivElement} cell
             * @param {Word} word
             * @param {number} letter
             * @param {number} x
             * @param {number} y
            */
            function setUpCell(cell, word, letter, x, y) {
                if (!cell.classList.contains('empty')) return;
                cell.classList.remove('empty');

                let input = cell.appendChild(
                    document.createElement('input')
                );
                input.classList.add('cell-input');
                input.dataset.x = x;
                input.dataset.y = y;
                input.id = `${x};${y}`;
                input.maxLength = 1;
                input.pattern = word.word[letter].toUpperCase();
                input.required = true;

                input.addEventListener('click', function (event) {
                    this.select();
                });

                input.addEventListener('input', function (event) {
                    this.value = this.value.toUpperCase();

                    // If the answer is correct, select the next letter
                    if (this.checkValidity()) {
                        /** @type {HTMLInputElement} */
                        let next = document.getElementById(
                            `${
                                isFlowVertical ? x : x + 1
                            };${
                                isFlowVertical ? y + 1 : y
                            }`
                        );

                        if (next && !next.classList.contains('number')) {
                            next.select();
                        } else {
                            // If it's the last letter, try to select the last number button
                            if (lastNumber) {
                                lastNumber.focus();
                            } else {
                                this.blur();
                            }
                        }
                    } else {
                        this.select();
                    }
                });
            }

            function fillGrid() {
                // Return if there are no words
                if (!words) return;

                // Reset numbers' counters
                /** @type {number} */
                let numVer = 0;
                /** @type {number} */
                let numHor = 0;

                // Reset maximum X and Y
                xMax = 0;
                yMax = 0;

                // Empty the questions
                while (verQuestions.hasChildNodes()) {
                    verQuestions.lastChild.remove();
                }

                while (horQuestions.hasChildNodes()) {
                    horQuestions.lastChild.remove();
                }

                // Empty the grid
                while (grid.hasChildNodes()) {
                    grid.lastChild.remove();
                }

                // Determine the maximum for X and Y
                words.forEach((w) => {
                    const x = w.x;
                    const y = w.y;
                    const l = w.word.length;

                    if (w.vertical) {
                        if (x > xMax) xMax = x;
                        if (y + l > yMax) yMax = y + l;
                    } else {
                        if (x + l > xMax) xMax = x + l;
                        if (y > yMax) yMax = y;
                    }
                });

                // Add one for numbers
                xMax ++;
                yMax ++;

                // Sort by column (X) and row (Y)
                words.sort((a, b) => a.x - b.x).sort((a, b) => a.y - b.y);

                // Prepare an empty grid
                for (var y = 0; y < yMax; y++) {
                    let row = grid.appendChild(
                        document.createElement('div')
                    );
                    row.classList.add('row');

                    for (var x = 0; x < xMax; x++) {
                        let cell = row.appendChild(
                            document.createElement('div')
                        );
                        cell.classList.add('cell', 'empty');
                    }
                }

                // Fill the grid
                words.forEach((w, wi) => {
                    if (isWordOutOfBounds(w)) return;

                    // Generate cell with number
                    if (w.vertical) {
                        numVer ++;
                    } else {
                        numHor ++;
                    }

                    setUpNumber(w, w.vertical ? numVer : numHor);

                    // Fill empty cells with letters
                    for (let i = 0; i < w.word.length; i++) {
                        const x = w.vertical
                            ? w.x
                            : w.x + i + 1;
                        const y = w.vertical
                            ? w.y + i + 1
                            : w.y;
                        const cell = grid.children[y].children[x];

                        setUpCell(cell, w, i, x, y);
                    }
                });
            }

            fillGrid();
        </script>
    </body>
</html>
